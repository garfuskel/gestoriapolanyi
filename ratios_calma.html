<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ràtios financeres</title>
<style>
    body { 
        font-family: 'Segoe UI', Arial, sans-serif; 
        background: #f0f2f5; 
        padding: 10px; 
        color: #333; 
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden; 
    }

    h1 { 
        text-align: center; 
        color: #2c3e50; 
        margin: 5px 0; 
        font-size: 1.5rem;
        text-transform: uppercase; 
        letter-spacing: 1px; 
    }
    
    p.subtitle { 
        text-align: center; 
        color: #666; 
        margin: 0 0 10px 0; 
        font-size: 0.9em; 
    }

    /* ESTRUCTURA DEL BALANÇ - DUES COLUMNES FIXES */
    .balance-container {
        display: flex;
        flex-direction: row; 
        flex-wrap: nowrap;   
        gap: 10px;           
        width: 98%;
        max-width: 1400px;
        margin: 0 auto;
        align-items: stretch; 
        flex: 1;              
    }

    .balance-column {
        background: white;
        padding: 15px;        
        border-radius: 10px;
        flex: 1;              
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        border-top: 4px solid #cbd5e0;
        display: flex;
        flex-direction: column;
    }

    .balance-column.assets { border-top-color: #3182ce; }
    .balance-column.liabilities { border-top-color: #e53e3e; }

    h2 { 
        margin: 0 0 10px 0; 
        font-size: 1.1em; 
        border-bottom: 2px solid #f0f2f5; 
        padding-bottom: 5px; 
        color: #2d3748; 
        text-align: center;
    }
    
    .mass-title { 
        font-weight: 800; 
        color: #2c5282; 
        margin-top: 10px; 
        margin-bottom: 2px; 
        text-transform: uppercase; 
        font-size: 0.85em; 
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .submass-title { 
        font-weight: 700; 
        color: #4a5568; 
        margin-top: 4px; 
        font-size: 0.8em; 
        font-style: italic;
    }

    /* FILES DE COMPTES - MÉS FINES */
    .account-row {
        display: flex;
        justify-content: space-between; 
        padding: 1px 0;      
        border-bottom: 1px dashed #edf2f7; 
        font-size: 0.85em;   
        color: #4a5568;
        align-items: center;
    }
    
    .account-val, .total-mass span, .grand-total span { 
        font-weight: bold; 
        font-family: 'Consolas', 'Monaco', monospace; 
        color: #2d3748; 
        text-align: right;
    }

    /* SUMATORIS PARCIALS */
    .total-mass {
        display: flex;
        justify-content: space-between;
        background: transparent; 
        padding: 2px 0; 
        margin-top: 0;
        font-weight: bold;
        border-top: 1px solid #718096; 
        font-size: 0.85em;
        color: #1a202c;
    }

    /* TOTALS FINALS */
    .grand-total {
        margin-top: auto; 
        padding: 10px;
        background: #2d3748;
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        border-radius: 6px;
        font-size: 1em;
        align-items: center;
    }
    
    .grand-total span { color: white; font-size: 1.1em; }

    /* ZONA DE PREGUNTES */
    .question-box {
        width: 98%;
        max-width: 1400px;
        margin: 10px auto;
        background: white;
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        text-align: center;
        border: 2px solid #3182ce;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
    }

    .question-title { 
        font-size: 1.1em; 
        font-weight: bold; 
        color: #2c3e50; 
        text-align: left;
        flex: 1;
    }
    
    .input-group { display: flex; align-items: center; gap: 10px; }
    
    input[type="number"] {
        padding: 8px;
        font-size: 1.1em;
        border: 2px solid #cbd5e0;
        border-radius: 6px;
        width: 120px;
        text-align: center;
        font-family: 'Consolas', monospace;
    }
    input[type="number"]:focus { border-color: #3182ce; outline: none; }

    button {
        padding: 8px 20px;
        font-size: 1em;
        font-weight: bold;
        color: white;
        background: #3182ce;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        white-space: nowrap;
    }
    button:hover { background: #2b6cb0; }
    
    .btn-next { background: #48bb78; display: none; }
    .btn-next:hover { background: #38a169; }

    #feedback { 
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 100;
        font-size: 1.2em;
        text-align: center;
        display: none;
        min-width: 300px;
    }
    .feedback-success { background: #f0fff4; color: #276749; border: 2px solid #48bb78; }
    .feedback-error { background: #fff5f5; color: #c53030; border: 2px solid #f56565; }
    .feedback-warning { background: #fffff0; color: #b7791f; border: 2px solid #ecc94b; }
</style>
</head>
<body>

<h1>RÀTIOS FINANCERES</h1>
<p class="subtitle">Calcula la ràtio demanada a partir de les dades del balanç</p>

<div class="balance-container">
    <div class="balance-column assets">
        <h2 style="color: #3182ce;">ACTIU</h2>
        
        <div class="mass-title">Actiu No Corrent</div>
        <div id="list-anc"></div>
        <div class="total-mass">Actiu no corrent: <span id="val-anc">0</span> </div>

        <div class="mass-title">Actiu Corrent</div>
        
        <div class="submass-title">Existències</div>
        <div id="list-ac-ex"></div>
        
        <div class="submass-title">Realitzable</div>
        <div id="list-ac-re"></div>
        
        <div class="submass-title">Disponible</div>
        <div id="list-ac-di"></div>
        
        <div class="total-mass" style="margin-top: 10px; border-top: 2px solid #3182ce;">Actiu corrent: <span id="val-ac">0</span></div>

        <div class="grand-total" style="background: #2b6cb0;">
            <span>TOTAL ACTIU</span>
            <span id="grand-actiu">0 €</span>
        </div>
    </div>

    <div class="balance-column liabilities">
        <h2 style="color: #e53e3e;">PATRIMONI NET I PASSIU</h2>

        <div class="mass-title">Patrimoni Net</div>
        <div id="list-pn"></div>
        <div class="total-mass">Patrimoni net: <span id="val-pn">0</span></div>

        <div class="mass-title">Passiu No Corrent</div>
        <div id="list-pnc"></div>
        <div class="total-mass">Passiu no corrent: <span id="val-pnc">0</span></div>

        <div class="mass-title">Passiu Corrent</div>
        <div id="list-pc"></div>
        <div class="total-mass" style="margin-top: 10px; border-top: 2px solid #e53e3e;">Passiu corrent: <span id="val-pc">0</span> </div>

        <div class="grand-total" style="background: #c53030;">
            <span>TOTAL PATRIMONI NET + PASSIU</span>
            <span id="grand-passiu">0 €</span>
        </div>
    </div>
</div>

<div class="question-box">
    <div id="q-text" class="question-title">Carregant...</div>
    <div class="input-group">
        <input type="number" id="user-answer" step="0.01" placeholder="0.00">
        <button id="btn-check" onclick="checkAnswer()">Comprovar</button>
        <button id="btn-next" class="btn-next" onclick="initGame()">Següent ➡</button>
    </div>
</div>

<div id="feedback" class="feedback-msg"></div>

<script>
// --- CONFIGURACIÓ ---
const db = {
    anc: ["Propietat industrial", "Aplicacions informàtiques", "Terrenys i béns naturals", "Construccions", "Instal·lacions tècniques", "Maquinària", "Utillatge", "Mobiliari", "Elements de transport", "Inversions financeres a llarg termini", "Inversions en terrenys i béns naturals", "Inversions en construccions"],
    ac_ex: ["Mercaderies", "Matèries primeres", "Productes acabats", "Altres aprovisionaments"],
    ac_re: ["Clients", "Deutors", "Inversions financeres a curt termini", "Hisenda Pública, deutora"],
    ac_di: ["Bancs", "Caixa"],
    pn: ["Reserva legal", "Reserves voluntàries"],
    pnc: ["Deutes a llarg termini amb entitats de crèdit", "Proveïdors d’immobilitzat a llarg termini", "Emprèstits (obligacions i bons a llarg termini)"],
    pc: ["Proveïdors", "Creditors", "Hisenda Pública, creditora", "Seguretat Social, creditora", "Deutes a curt termini amb entitats de crèdit"]
};

let currentValues = {}; 
let currentQuestion = null;

// --- GENERADOR DE NÚMEROS ALEATORIS ---
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function fmt(num) { return num.toLocaleString('ca-ES'); }

// --- FUNCIONS AUXILIARS PER EVITAR DUPLICATS ---
function getRandomUniqueItems(array, count) {
    let shuffled = array.slice(0);
    let i = array.length, temp, index;
    while (i--) {
        index = Math.floor((i + 1) * Math.random());
        temp = shuffled[index];
        shuffled[index] = shuffled[i];
        shuffled[i] = temp;
    }
    return shuffled.slice(0, count);
}

// --- GENERADOR DE BALANÇ ---
function initGame() {
    document.getElementById("feedback").style.display = "none";
    document.getElementById("btn-next").style.display = "none";
    document.getElementById("btn-check").style.display = "inline-block";
    document.getElementById("user-answer").value = "";
    document.getElementById("user-answer").disabled = false;

    // 1. Generar Actius
    let html_anc = "", t_anc = 0;
    let ancItems = getRandomUniqueItems(db.anc, rand(3, 4));
    ancItems.forEach(c => {
        let v = rand(10, 50) * 1000;
        t_anc += v;
        html_anc += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });
    // Amortització
    let amort = rand(5, 15) * -1000;
    t_anc += amort;
    html_anc += `<div class="account-row"><span>Amortització acumulada de l'immobilitzat</span><span class="account-val">${fmt(amort)}</span></div>`;
    
    // Generar AC
    let html_ac_ex = "", t_ac_ex = 0;
    let exItems = getRandomUniqueItems(db.ac_ex, 1);
    exItems.forEach(c => {
        let v = rand(5, 20) * 1000; t_ac_ex += v;
        html_ac_ex += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });

    let html_ac_re = "", t_ac_re = 0;
    let reItems = getRandomUniqueItems(db.ac_re, 1);
    reItems.forEach(c => {
        let v = rand(5, 20) * 1000; t_ac_re += v;
        html_ac_re += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });

    let html_ac_di = "", t_ac_di = 0;
    let diItems = getRandomUniqueItems(db.ac_di, 1);
    diItems.forEach(c => {
        let v = rand(2, 15) * 1000; t_ac_di += v;
        html_ac_di += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });

    let t_ac = t_ac_ex + t_ac_re + t_ac_di;
    let total_actiu = t_anc + t_ac;

    // 2. Generar Passius
    let html_pnc = "", t_pnc = 0;
    let pncItems = getRandomUniqueItems(db.pnc, rand(1, 2));
    pncItems.forEach(c => {
        let v = rand(10, 30) * 1000; t_pnc += v;
        html_pnc += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });

    let html_pc = "", t_pc = 0;
    let pcItems = getRandomUniqueItems(db.pc, rand(2, 3));
    pcItems.forEach(c => {
        let v = rand(5, 25) * 1000; t_pc += v;
        html_pc += `<div class="account-row"><span>${c}</span><span class="account-val">${fmt(v)}</span></div>`;
    });

    // 3. Calcular Patrimoni Net
    let html_pn = "", t_pn = 0;
    let resultat = rand(1, 15) * 1000 * (Math.random() > 0.3 ? 1 : -1);
    let reserves = rand(5, 20) * 1000;
    
    let passiu_exigible = t_pnc + t_pc;
    let capital = total_actiu - passiu_exigible - reserves - resultat;
    
    // CORRECCIÓ DE CAPITAL BAIX (SENSE COMPTE NOU)
    if (capital < 5000) {
        let diff = 5000 - capital;
        capital = 5000;
        
        // Ajustem internament els valors per quadrar
        t_ac_di += diff;
        t_ac += diff;
        total_actiu += diff;
        
        // Regenerem la línia de Disponible amb el nou import (invisible)
        html_ac_di = `<div class="account-row"><span>${diItems[0]}</span><span class="account-val">${fmt(t_ac_di)}</span></div>`;
    }

    t_pn = capital + reserves + resultat;
    
    html_pn += `<div class="account-row"><span>Capital</span><span class="account-val">${fmt(capital)}</span></div>`;
    html_pn += `<div class="account-row"><span>Reserves</span><span class="account-val">${fmt(reserves)}</span></div>`;
    html_pn += `<div class="account-row"><span>Resultat de l'exercici</span><span class="account-val">${fmt(resultat)}</span></div>`;

    let total_passiu = t_pn + t_pnc + t_pc;

    // 4. Renderitzar
    document.getElementById("list-anc").innerHTML = html_anc;
    document.getElementById("val-anc").textContent = "?";
    
    document.getElementById("list-ac-ex").innerHTML = html_ac_ex;
    document.getElementById("list-ac-re").innerHTML = html_ac_re;
    document.getElementById("list-ac-di").innerHTML = html_ac_di;
    document.getElementById("val-ac").textContent = "?";

    document.getElementById("grand-actiu").textContent = fmt(total_actiu);

    document.getElementById("list-pn").innerHTML = html_pn;
    document.getElementById("val-pn").textContent = "?";

    document.getElementById("list-pnc").innerHTML = html_pnc;
    document.getElementById("val-pnc").textContent = "?";

    document.getElementById("list-pc").innerHTML = html_pc;
    document.getElementById("val-pc").textContent = "?";

    document.getElementById("grand-passiu").textContent = fmt(total_passiu);

    // 5. Guardar valors
    currentValues = {
        ac: t_ac,
        pc: t_pc,
        real: t_ac_re,
        disp: t_ac_di,
        anc: t_anc,
        pn: t_pn,
        pnc: t_pnc,
        pt: total_passiu,
        passiu_exigible: t_pnc + t_pc,
        actiu_total: total_actiu
    };

    generateQuestion();
}

// --- GENERADOR DE PREGUNTES ---
function generateQuestion() {
    const qTypes = [
        { id: "fm", text: "Fons de Maniobra", form: "Actiu corrent - Passiu corrent", calc: (v) => v.ac - v.pc },
        { id: "liq", text: "Ràtio de Liquiditat", form: "Actiu corrent / Passiu corrent", calc: (v) => v.ac / v.pc },
        { id: "tres", text: "Ràtio de Tresoreria", form: "(Realitzable + Disponible) / Passiu corrent", calc: (v) => (v.real + v.disp) / v.pc },
        { id: "disp", text: "Ràtio de Disponibilitat", form: "Disponible / Passiu corrent", calc: (v) => v.disp / v.pc },
        { id: "gar", text: "Ràtio de Garantia", form: "Actiu / Passiu", calc: (v) => v.actiu_total / v.passiu_exigible },
        { id: "aut", text: "Ràtio d'Autonomia Financera", form: "Patrimoni net / Passiu", calc: (v) => v.pn / v.passiu_exigible },
        { id: "qual", text: "Ràtio de Qualitat del Deute", form: "Passiu corrent / Passiu", calc: (v) => v.pc / v.passiu_exigible },
        { id: "end", text: "Ràtio d'Endeutament", form: "Passiu / (Passiu + Patrimoni net)", calc: (v) => v.passiu_exigible / v.pt }
    ];

    let q = qTypes[Math.floor(Math.random() * qTypes.length)];
    currentQuestion = q;
    
    document.getElementById("q-text").textContent = "Calcula: " + q.text;
}

// --- COMPROVACIÓ ---
function checkAnswer() {
    let inputStr = document.getElementById("user-answer").value;
    let feedbackDiv = document.getElementById("feedback");
    
    // Tancar missatge anterior si hi és
    feedbackDiv.style.display = "none";
    
    if (inputStr.trim() === "") {
        feedbackDiv.style.display = "block";
        feedbackDiv.className = "feedback-msg feedback-warning";
        feedbackDiv.innerHTML = "⚠️ Introdueix una resposta ⚠️";
        setTimeout(() => feedbackDiv.style.display = "none", 1500);
        return; 
    }

    let input = parseFloat(inputStr.replace(',', '.'));
    let correct = currentQuestion.calc(currentValues);
    let correctRounded = parseFloat(correct.toFixed(2));
    
    let isCorrect = Math.abs(input - correct) < 0.02 || Math.abs(input - correctRounded) < 0.02;

    feedbackDiv.style.display = "block";

    if (isCorrect) {
        feedbackDiv.className = "feedback-msg feedback-success";
        feedbackDiv.innerHTML = `
            <div style="font-weight:bold; font-size:1.4em">✅ CORRECTE!</div>
            <div style="margin-top:10px; font-size:0.9em">
                Solució: <b>${correct.toLocaleString('ca-ES', {maximumFractionDigits: 2})}</b><br>
                Fórmula: <span style="font-family:monospace">${currentQuestion.form}</span>
            </div>
            <button onclick="document.getElementById('feedback').style.display='none'" style="margin-top:10px; background:#276749;">Tancar</button>
        `;
        document.getElementById("btn-check").style.display = "none";
        document.getElementById("btn-next").style.display = "inline-block";
        document.getElementById("user-answer").disabled = true;
    } else {
        feedbackDiv.className = "feedback-msg feedback-error";
        feedbackDiv.innerHTML = `
            <div style="font-weight:bold; font-size:1.4em">❌ INCORRECTE</div>
            <div style="margin-top:10px; font-size:0.9em">
                Solució: <b>${correct.toLocaleString('ca-ES', {maximumFractionDigits: 2})}</b><br>
                Fórmula: <span style="font-family:monospace">${currentQuestion.form}</span>
            </div>
            <button onclick="document.getElementById('feedback').style.display='none'" style="margin-top:10px; background:#c53030;">Tancar</button>
        `;
        document.getElementById("btn-check").style.display = "none";
        document.getElementById("btn-next").style.display = "inline-block";
    }
}

initGame();
</script>
</body>
</html>