<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Balan√ß Infinity - Mode Visual Pro</title>
<style>
    /* PROTECCI√ì MOBIL */
    body { 
        font-family: 'Segoe UI', Arial, sans-serif; 
        background: #f0f2f5; 
        padding: 20px; 
        color: #333; 
        margin-top: 60px;
        overscroll-behavior-y: contain; 
        touch-action: pan-x pan-y; 
    }

    h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
    p.subtitle { text-align: center; color: #666; margin-bottom: 25px; }
    
    /* CRON√íMETRE SUPERIOR */
    #timer-container { width: 100%; background-color: #e2e8f0; height: 35px; position: fixed; top: 0; left: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #timer-bar { width: 100%; height: 100%; background-color: #48bb78; transition: width 0.1s linear; }
    #ui-overlay { position: absolute; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; line-height: 35px; font-weight: bold; font-size: 18px; color: #2d3748; pointer-events: none; }

    .container { display: flex; gap: 15px; justify-content: center; }
    .column { background: white; padding: 15px; border-radius: 10px; width: 32%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .dropzone { min-height: 100px; border: 2px dashed #cbd5e0; padding: 10px; margin-bottom: 15px; border-radius: 6px; background: #fafafa; transition: 0.2s; }
    .dropzone:hover { border-color: #3182ce; background: #f0f7ff; }
    
    .account { background: #ebf4ff; padding: 8px; margin: 5px 0; border-radius: 4px; cursor: grab; border: 1px solid #bee3f8; font-size: 0.85em; transition: 0.3s; user-select: none; }
    .account.is-wrong { border: 4px solid #ff0000 !important;      /* Vora vermella forta */
        background-color: #ffe6e6 !important;      /* Fons rosat (no blanc) */
        color: #d60000 !important;                 /* LLETRA VERMELLA (For√ßat) */
        font-weight: 900 !important;               /* Lletra molt gruixuda */
        animation: shakeMini 0.4s;                 /* Mant√© la vibraci√≥ */; }
    .account.is-trap-active { background: #fed7d7 !important; border-color: #f56565 !important; color: #822727 !important; font-weight: bold; }
    
    .total-box { font-weight: bold; background: #edf2f7; padding: 10px; border-radius: 5px; margin-top: 5px; text-align: right; color: #4a5568; }
    .controls { text-align: center; margin: 25px 0; }
    button { padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
    .btn-check { background: #3182ce; color: white; }

    /* OVERLAYS */
    .overlay-feedback {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(8px); 
        z-index: 5000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        animation: fadeIn 0.3s ease-out;
    }
    
    .msg-box {
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
        max-width: 900px; /* M√©s ample per encabir la imatge al costat */
        width: 90%;
        max-height: 95vh;
        overflow-y: auto;
        animation: scaleUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* ESTRUCTURA FLEX PER A LA FINESTRA FINAL */
    .feedback-layout {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 40px;
        text-align: left;
    }

    .feedback-info { flex: 1; }
    
    .feedback-img-container {
        flex: 0 0 300px; /* Amplada fixa per la imatge */
        display: flex;
        justify-content: center;
    }

    .rank-img {
        width: 100%;
        max-width: 300px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        border: 6px solid white;
        transform: rotate(2deg); /* Petit gir est√®tic */
        transition: transform 0.3s;
    }
    .rank-img:hover { transform: rotate(0deg) scale(1.05); }

    .msg-title { font-size: 45px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; line-height: 1; }
    .msg-subtitle { font-size: 22px; font-weight: bold; opacity: 0.9; margin-bottom: 15px; }
    .rank-display { font-size: 26px; color: #2b6cb0; margin: 15px 0; font-weight: bold; padding: 15px; background: #ebf8ff; border-radius: 10px; border-left: 5px solid #3182ce; }

    /* MEDIA QUERY PER A M√íBILS */
    @media (max-width: 768px) {
        .feedback-layout { flex-direction: column-reverse; text-align: center; gap: 20px; }
        .feedback-img-container { flex: none; width: 200px; }
        .msg-title { font-size: 35px; }
    }

    .type-success .msg-box { background: #f0fff4; border: 5px solid #48bb78; color: #2f855a; }
    .type-warning .msg-box { background: #fffff0; border: 5px solid #ecc94b; color: #b7791f; }
    .type-error .msg-box { background: white; border: 5px solid #f56565; color: white; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes shakeMini { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
</style>
</head>
<body>

<div id="timer-container">
    <div id="ui-overlay">
        <div>Nivell: <span id="currentLevel">0</span></div>
        <div>Temps: <span id="seconds">300</span>s</div>
        <div>Correctes: <span id="balancosCorrectes">0</span></div>
    </div>
    <div id="timer-bar"></div>
</div>

<h1>Balan√ß de situaci√≥</h1>
<p class="subtitle">Arriba al m√†xim nivell professional abans que s'acabi el temps!</p>

<div class="container">
    <div class="column">
        <h3>Comptes</h3>
        <div id="accountsList" class="dropzone"></div>
    </div>

    <div class="column">
        <h3 style="color: #2b6cb0;">ACTIU</h3>
        <strong>Actiu no corrent</strong>
        <div id="target-anc" class="dropzone subzone" data-cat="anc"></div>
        <strong>Actiu corrent</strong>
        <div id="target-ac" class="dropzone subzone" data-cat="ac"></div>
        <div class="total-box">Total Actiu: <span id="totalActiu">---</span></div>
    </div>

    <div class="column">
        <h3 style="color: #2b6cb0;">PATRIMONI NET I PASSIU</h3>
        <strong>Patrimoni net</strong>
        <div id="target-pn" class="dropzone subzone" data-cat="pn"></div>
        <strong>Passiu no corrent</strong>
        <div id="target-pnc" class="dropzone subzone" data-cat="pnc"></div>
        <strong>Passiu corrent</strong>
        <div id="target-pc" class="dropzone subzone" data-cat="pc"></div>
        <div class="total-box">Total P+PN: <span id="totalPassiu">---</span></div>
    </div>
</div>

<div class="controls">
    <button class="btn-check" id="btnCheck" onclick="comprovar()">Comprovar Balan√ß</button>
</div>

<script>
let draggedItem = null;
let intents = 0;
let finished = false;
let dadesSolucio = [];
let tempsRestant = 300;
let tempsTotalMaxim = 300;
let nivellActual = 0;
let balancosAquestNivell = 0;
let totalCorrectes = 0;
let intervalRellotge = null;
let allowExit = false;

// DEFINICI√ì DE NIVELLS (RANKS)
const ranks = [
    "Aspirant a comptable",       // 0
    "Becari en pr√†ctiques",       // 1
    "Auxiliar administratiu",     // 2
    "Comptable J√∫nior",           // 3
    "Comptable S√®nior",           // 4
    "Cap de Comptabilitat",       // 5
    "Auditor Intern",             // 6
    "Controller Financer",        // 7
    "Director Financer (CFO)",    // 8
    "Soci de la Firma",           // 9
    "LLEGENDA DEL BALAN√á"         // 10
];

window.addEventListener('beforeunload', function (e) {
    if (!allowExit) { e.preventDefault(); e.returnValue = ''; }
});

const db = {
    anc: ["Propietat industrial", "Aplicacions inform√†tiques", "Terrenys i b√©ns naturals", "Construccions", "Instal¬∑lacions t√®cniques", "Maquin√†ria", "Utillatge", "Mobiliari", "Equips per a processos d‚Äôinformaci√≥", "Elements de transport", "Inversions en terrenys i b√©ns naturals", "Inversions en construccions", "Inversions financeres a llarg termini en instruments de patrimoni", "Cr√®dits a llarg termini per alienaci√≥ d'immobilitzat"],
    ac_ex: ["Mercaderies", "Mat√®ries primeres", "Productes acabats", "Altres aprovisionaments"],
    ac_re: ["Clients", "Clients, efectes comercials a cobrar", "Deutors", "Deutors, efectes comercials a cobrar", "Inversions financeres a curt termini en instruments de patrimoni", "Hisenda P√∫blica, deutora per diferents conceptes"],
    ac_di: ["Bancs i institucions de cr√®dit", "Caixa"],
    pn: ["Reserva legal", "Reserves volunt√†ries", "Reserves estatut√†ries"],
    pnc: ["Deutes a llarg termini amb entitats de cr√®dit", "Prove√Ødors d‚Äôimmobilitzat a llarg termini", "Empr√®stits (Bons i obligacions)"],
    pc: ["Prove√Ødors", "Creditors per prestaci√≥ de serveis", "Hisenda P√∫blica, creditora per conceptes fiscals", "Seguretat Social, creditora", "Deutes a curt termini amb entitats de cr√®dit", "Prove√Ødors, efectes comercials a pagar", "Creditors, efectes comercials a pagar", "Prove√Ødors d'immobilitzat a curt termini"],
    trampes: ["Vendes de mercaderies", "Prestacions de serveis", "Devolucions per compres", "R√†pels per compres", "Descomptes sobre compres per pagament immediat", "Ingressos per arrendaments", "Variaci√≥ d'exist√®ncies", "Compres de mercaderies", "Compres de mat√®ries primeres", "Devolucions de vendes i operacions similars", "R√†pels sobre vendes", "Descomptes sobre vendes per pagament immediat", "Arrendaments i c√†nons", "Serveis de professionals independents", "Transports", "Prima d'assegurances", "Reparaci√≥ i conservaci√≥", "Subministraments", "Altres tributs", "Sous i salaris", "Seguretat Social a c√†rrec de l'empresa", "Serveis bancaris", "Quota d'amortitzaci√≥ de l'immobilitzat", "Altres ingressos financers", "Interessos de deutes", "Impost sobre beneficis"]
};

function iniciarRellotge() {
    if (intervalRellotge) clearInterval(intervalRellotge);
    let factorVelocitat = 1 + (nivellActual * 0.1);
    intervalRellotge = setInterval(() => {
        if (finished) return;
        tempsRestant--;
        actualitzarInterficie();
        if (tempsRestant <= 0) finalitzarJoc();
    }, 1000 / factorVelocitat);
}

function actualitzarInterficie() {
    document.getElementById("seconds").textContent = Math.max(0, tempsRestant);
    document.getElementById("timer-bar").style.width = Math.min(100, (tempsRestant / tempsTotalMaxim * 100)) + "%";
    
    if ((tempsRestant / tempsTotalMaxim) < 0.2) document.getElementById("timer-bar").style.backgroundColor = "#e53e3e";
    else if ((tempsRestant / tempsTotalMaxim) < 0.5) document.getElementById("timer-bar").style.backgroundColor = "#ecc94b";
    else document.getElementById("timer-bar").style.backgroundColor = "#48bb78";
}

function mostrarFeedback(titol, subtitol, tipus, durada = 1500) {
    let antic = document.querySelector('.overlay-feedback');
    if (antic) antic.remove();

    const overlay = document.createElement("div");
    overlay.className = `overlay-feedback type-${tipus}`;
    
    overlay.innerHTML = `
        <div class="msg-box" style="text-align:center;">
            <div class="msg-title">${titol}</div>
            <div class="msg-subtitle">${subtitol}</div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    if (durada > 0) {
        setTimeout(() => {
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        }, durada);
    }
}

function generarExercici() {
    let antic = document.querySelector('.overlay-feedback');
    if (antic) antic.remove();

    document.getElementById("accountsList").innerHTML = "";
    document.querySelectorAll(".dropzone").forEach(z => { z.innerHTML = ""; z.classList.remove("is-wrong"); });
    document.getElementById("totalActiu").textContent = "---";
    document.getElementById("totalPassiu").textContent = "---";
    
    intents = 0; finished = false; dadesSolucio = [];
    document.getElementById("btnCheck").disabled = false;
    document.getElementById("btnCheck").style.opacity = "1";

    if (!intervalRellotge) iniciarRellotge();

    let tempAccounts = [];
    let numAnc = Math.floor(Math.random() * 3) + 2; 
    db.anc.sort(() => 0.5 - Math.random()).slice(0, numAnc).forEach(c => tempAccounts.push({c, cat: 'anc'}));
    tempAccounts.push({c: "Amortitzaci√≥ acumulada de l'immobilitzat", cat: 'anc', isAmort: true});

    let numAc = Math.floor(Math.random() * 3) + 3;
    let poolAc = [...db.ac_ex, ...db.ac_re, ...db.ac_di];
    poolAc.sort(() => 0.5 - Math.random()).slice(0, numAc).forEach(c => tempAccounts.push({c, cat: 'ac'}));

    let numPnc = Math.floor(Math.random() * 2) + 1;
    db.pnc.sort(() => 0.5 - Math.random()).slice(0, numPnc).forEach(c => tempAccounts.push({c, cat: 'pnc'}));

    let numPc = Math.floor(Math.random() * 3) + 2;
    db.pc.sort(() => 0.5 - Math.random()).slice(0, numPc).forEach(c => tempAccounts.push({c, cat: 'pc'}));

    let numPn = Math.floor(Math.random() * 2) + 1;
    db.pn.sort(() => 0.5 - Math.random()).slice(0, numPn).forEach(c => tempAccounts.push({c, cat: 'pn'}));
    tempAccounts.push({c: "Resultat de l'exercici", cat: 'pn', isResult: true});

    let TotalActiu = 0, TotalPassiuExigible = 0, TotalNetFixe = 0; 

    tempAccounts.forEach(item => {
        let val;
        if (item.isAmort) {
            val = (Math.floor(Math.random()*4)+2) * -1000;
        } else if (item.isResult) {
            val = (Math.floor(Math.random()*5)+2) * 1000 * (Math.random() > 0.4 ? 1 : -1);
        } else {
            val = (Math.floor(Math.random()*15)+5) * 1000; 
        }
        item.v = val;
        if (item.cat === 'anc' || item.cat === 'ac') TotalActiu += val;
        else if (item.cat === 'pnc' || item.cat === 'pc') TotalPassiuExigible += val;
        else if (item.cat === 'pn') TotalNetFixe += val;
        dadesSolucio.push({...item, trap: false});
    });

    let capitalCalculat = TotalActiu - TotalPassiuExigible - TotalNetFixe;
    
    if (capitalCalculat <= 5000) {
        let deficit = 5000 - capitalCalculat; 
        capitalCalculat = 5000;
        let compteBancs = dadesSolucio.find(d => d.c.includes("Bancs"));
        if (compteBancs) {
            compteBancs.v += deficit;
        } else {
            dadesSolucio.push({c: "Bancs i institucions de cr√®dit", v: deficit, cat: 'ac', trap: false});
        }
        TotalActiu += deficit; 
    }

    dadesSolucio.push({c: "Capital Social", v: capitalCalculat, cat: "pn", trap: false});

    let numTrampes = Math.floor(Math.random() * 2) + 1;
    db.trampes.sort(() => 0.5 - Math.random()).slice(0, numTrampes).forEach(c => {
        dadesSolucio.push({c, v: 1000, cat: "none", trap: true, id: "t-" + Math.random().toString(36).substr(2, 5)});
    });

    dadesSolucio.sort(() => 0.5 - Math.random()).forEach(o => {
        let d = document.createElement("div");
        d.className = "account"; d.draggable = true;
        d.id = o.id || "acc-" + o.c.replace(/\s+/g, '-');
        d.dataset.cat = o.cat; d.dataset.trap = o.trap; d.dataset.value = o.v;
        d.textContent = `${o.c}: ${o.v.toLocaleString()} ‚Ç¨`;
        d.addEventListener("dragstart", () => draggedItem = d);
        document.getElementById("accountsList").appendChild(d);
    });
}

document.querySelectorAll(".dropzone").forEach(z => {
    z.addEventListener("dragover", e => e.preventDefault());
    z.addEventListener("drop", () => { if (draggedItem) z.appendChild(draggedItem); });
});

function comprovar() {
    if (finished) return;
    let a=0, p=0, correcte = true;
    const collocats = document.querySelectorAll(".subzone .account");
    
    document.querySelectorAll("#target-anc .account, #target-ac .account").forEach(i => a += Number(i.dataset.value));
    document.querySelectorAll("#target-pn .account, #target-pnc .account, #target-pc .account").forEach(i => p += Number(i.dataset.value));
    
    document.getElementById("totalActiu").textContent = a.toLocaleString() + " ‚Ç¨";
    document.getElementById("totalPassiu").textContent = p.toLocaleString() + " ‚Ç¨";

    collocats.forEach(el => {
        if (el.dataset.trap === "true" || el.parentElement.dataset.cat !== el.dataset.cat) correcte = false;
    });

    let comptesReals = dadesSolucio.filter(s => !s.trap).length;
    if (collocats.length < comptesReals) correcte = false;

    if (correcte && a === p && a !== 0) {
        // ENCERT
        totalCorrectes++;
        balancosAquestNivell++;
        document.getElementById("balancosCorrectes").textContent = totalCorrectes;
        
        let bonus = (intents === 0) ? 60 : (intents === 1) ? 30 : 10;
        tempsRestant += bonus;
        if (tempsRestant > tempsTotalMaxim) tempsTotalMaxim = tempsRestant;
        
        mostrarFeedback("BEN FET", `Has guanyat +${bonus} segons ‚≠ê`, "success", 2000);
        
        if (balancosAquestNivell >= 2 && nivellActual < 10) {
            nivellActual++;
            balancosAquestNivell = 0;
            document.getElementById("currentLevel").textContent = nivellActual;
            iniciarRellotge(); 
        }
        
        finished = true;
        setTimeout(generarExercici, 2000);

    } else {
        // ERROR
        intents++;
        if (intents === 2) {
            mostrarFeedback("üòü ALERTA üòü", "Darerra oportunitat", "warning", 2500);
            collocats.forEach(el => {
                if (el.dataset.trap === "true" || el.parentElement.dataset.cat !== el.dataset.cat) el.classList.add("is-wrong");
            });
        } else if (intents >= 3) {
            finished = true;
            mostrarFeedback("üò± INCORRECTE üò±", "Prepara't per al seg√ºent balan√ß", "error", 4000);
            dadesSolucio.forEach(item => {
                let el = document.getElementById(item.id || "acc-" + item.c.replace(/\s+/g, '-'));
                if (!item.trap) document.getElementById("target-" + item.cat).appendChild(el);
            });
            setTimeout(generarExercici, 4000);
        } else {
            mostrarFeedback("ü§® EL BALAN√á NO √âS CORRECTE ü§®", "Tens dos intents m√©s", "warning", 2000);
        }
    }
}

function reloadGame() {
    allowExit = true;
    location.reload();
}

function finalitzarJoc() {
    finished = true;
    clearInterval(intervalRellotge);
    
    // Obtenir nom del rang
    let nomRang = nivellActual >= ranks.length ? ranks[ranks.length-1] : ranks[nivellActual];
    // Construir cam√≠ imatge (si el nivell √©s > 10, es queda amb la 10)
    let imatgeNivell = `nivells/nivell${Math.min(10, nivellActual)}.jpg`;

    let go = document.createElement("div");
    go.className = "overlay-feedback type-error";
    go.style.zIndex = "6000";
    go.innerHTML = `
        <div class="msg-box">
            <div class="feedback-layout">
                <div class="feedback-info">
                    <div class="msg-title" style="color:#e53e3e;">GAME OVER</div>
                    <div class="rank-display">
                        NIVELL ${nivellActual}: ${nomRang}
                    </div>
                    <p style="font-size:20px; margin:20px 0; color:#4a5568;">
                        Has quadrat correctament <b>${totalCorrectes}</b> balan√ßos.
                    </p>
                    <button onclick="reloadGame()" style="background:#3182ce; color:white; padding:15px 40px; border-radius:10px; border:none; cursor:pointer; font-size:22px; font-weight:bold; margin-top:20px; width:100%;">TORNA A JUGAR</button>
                </div>
                
                <div class="feedback-img-container">
                    <img src="${imatgeNivell}" class="rank-img" alt="Imatge de rang ${nomRang}" onerror="this.style.display='none'">
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(go);
}

generarExercici();
</script>
</body>
</html>