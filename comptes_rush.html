<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestoria Polanyi - Estructura del balan√ß de situaci√≥</title>
    <style>
        :root {
            --anc-color: #2980b9; --ac-color: #3498db;
            --pn-color: #8e44ad; --pnc-color: #c0392b; --pc-color: #e74c3c;
            --bg-color: #f4f7f6; --text-color: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            touch-action: none; /* Bloqueja scroll i zoom a tota la pantalla */
            user-select: none; /* Evita seleccionar text al jugar */
            -webkit-user-select: none;
        }

        .game-container {
            background: white;
            width: 100%;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
            max-height: 800px;
        }

        /* --- ZONA SUPERIOR: JOC CANVAS I HUD --- */
        .game-view {
            position: relative;
            background: #ecf0f1;
            flex-grow: 1;
            border-bottom: 3px solid #bdc3c7;
            overflow: hidden;
            min-height: 200px; 
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .hud {
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            text-transform: uppercase;
            pointer-events: none;
            z-index: 50;
        }

        .hearts {
            color: #e74c3c;
            font-size: 1.5rem;
            letter-spacing: 5px;
        }

        /* --- ZONA CENTRAL: LA PREGUNTA --- */
        .question-box {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-account {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.1;
        }

        /* --- ZONA INFERIOR: BOTONS --- */
        .controls-area {
            flex-shrink: 0;
            height: 320px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: white;
        }

        .col-actiu, .col-passiu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .col-header {
            text-align: center; font-weight: bold; color: #7f8c8d;
            font-size: 0.8rem; text-transform: uppercase;
        }

        .btn-option {
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; color: white; text-transform: uppercase;
            box-shadow: 0 4px 0px rgba(0,0,0,0.2);
            flex: 1; transition: top 0.1s, box-shadow 0.1s;
            position: relative; top: 0;
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation; /* Millora resposta t√†ctil */
            -webkit-tap-highlight-color: transparent;
        }

        .btn-option:active { box-shadow: 0 0px 0px rgba(0,0,0,0.2); top: 4px; }
        
        /* Colors */
        .btn-anc { background-color: var(--anc-color); }
        .btn-ac  { background-color: var(--ac-color); }
        .btn-pn  { background-color: var(--pn-color); }
        .btn-pnc { background-color: var(--pnc-color); }
        .btn-pc  { background-color: var(--pc-color); }

        /* --- OVERLAY GAME OVER / INICI --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); color: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; 
        }
        .overlay.hidden { display: none; }
        
        /* Mides compactes per evitar talls */
        .game-over-title { 
            font-size: 1.8rem;  
            font-weight: 900; 
            color: var(--pc-color); 
            margin-bottom: 2px; 
            line-height: 1; 
        }
        .final-score { font-size: 1rem; margin-bottom: 5px; }
        
        /* Estil del bot√≥ */
        .btn-start {
            padding: 10px 24px; 
            font-size: 1.1rem; 
            font-weight: bold;
            background: var(--ac-color); 
            color: white; border: none; border-radius: 8px;
            cursor: pointer; box-shadow: 0 6px 0 #217dbb; 
            margin-top: 10px; 
            margin-bottom: 5px;
            transition: all 0.1s; position: relative; top:0;
            display: inline-block;
            flex-shrink: 0; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-start:active { top: 6px; box-shadow: 0 0 0 #217dbb; }

        /* Animacions */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        .flash-red { animation: flashRed 0.3s; }
        @keyframes flashRed { 0% { background-color: #e74c3c; } 100% { background-color: #ecf0f1; } }

        /* AQUEST √âS L'√öNIC BLOC MODIFICAT PER ADAPTAR-HO A UNA SOLA PANTALLA T√ÄCTIL SENSE SCROLL */
        @media (max-width: 600px) {
            body { padding: 0; }
            .game-container { height: 100vh; max-height: 100vh; border-radius: 0; }
            .controls-area { height: 260px; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            .col-actiu, .col-passiu { height: 100%; gap: 8px; }
            .col-header { font-size: 0.7rem; }
            .btn-option { font-size: 0.85rem; padding: 5px; }
            .current-account { font-size: 1.3rem; }
            .question-box { min-height: 60px; padding: 5px 10px; }
            .hud { font-size: 1rem; }
            .game-over-title { font-size: 1.6rem; } 
        }
    </style>
</head>
<body>

<div class="game-container">
    <div id="gameView" class="game-view">
        <div class="hud">
            <div id="scoreDisplay">PUNTS: 0</div>
            <div id="livesDisplay" class="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        
        <div id="overlay" class="overlay">
            <div id="gameOverContent" style="display: none;">
                <div class="game-over-title">GAME OVER</div>
                <div class="final-score" id="finalScoreContainer">Has aconseguit <span id="finalScore">0</span> encerts</div>
                <div id="deathReason" style="color: #bdc3c7; margin-bottom: 5px; font-size: 0.9rem; max-width: 95%;"></div>
            </div>
            <div id="startContent">
                <h1 style="font-size: 2rem; margin-bottom: 5px; line-height: 1.2;">GESTORIA RUSH</h1>
                <h2 style="font-size: 1.2rem; color: #3498db; margin-top:0;">ESTRUCTURA DEL BALAN√á DE SITUACI√ì</h2>
                <p style="font-size: 1rem; margin-bottom: 10px; max-width: 500px;">
                    Tens 3 vides ‚ù§Ô∏è Encerta i salta en el moment oport√∫ üìë
                </p>
            </div>
            <button id="mainBtn" class="btn-start" onpointerdown="startGame(); event.preventDefault()">JUGAR</button>
        </div>
    </div>

    <div class="question-box" id="questionBox">
        <div id="currentAccountText" class="current-account">...</div>
    </div>

    <div class="controls-area">
        <div class="col-actiu">
            <div class="col-header">Actiu</div>
            <button class="btn-option btn-anc" onpointerdown="checkAnswer('ANC'); event.preventDefault()">Actiu No Corrent</button>
            <button class="btn-option btn-ac" onpointerdown="checkAnswer('AC'); event.preventDefault()">Actiu Corrent</button>
        </div>
        <div class="col-passiu">
            <div class="col-header">Patrimoni net i Passiu</div>
            <button class="btn-option btn-pn" onpointerdown="checkAnswer('PN'); event.preventDefault()">Patrimoni Net</button>
            <button class="btn-option btn-pnc" onpointerdown="checkAnswer('PNC'); event.preventDefault()">Passiu No Corrent</button>
            <button class="btn-option btn-pc" onpointerdown="checkAnswer('PC'); event.preventDefault()">Passiu Corrent</button>
        </div>
    </div>
</div>

<script>
    // === CONFIGURACI√ì DEL PROFESSOR ===
    const CONFIG = {
        velocitatInicial: 3.5,
        incrementVelocitat: 0.3,  
        velocitatMaxima: 40,      
        freqObstacles: 160 
    };

    // === GESTOR D'AUDIO ===
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'jump') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'gameover') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 1.5);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 1.5);
            osc.start(now);
            osc.stop(now + 1.5);
        }
    }

    // === BASE DE DADES ===
    
    const comptesDB = [
    { nom: "Propietat industrial", grup: "ANC" },
    { nom: "Aplicacions inform√†tiques", grup: "ANC" },
    { nom: "Amortitzaci√≥ acumulada de l'immobilitzat immaterial (AAII)", grup: "ANC" },
    { nom: "Terrenys i b√©ns naturals", grup: "ANC" },
    { nom: "Construccions", grup: "ANC" },
    { nom: "Instal¬∑lacions t√®cniques", grup: "ANC" },   
    { nom: "Maquin√†ria", grup: "ANC" },
    { nom: "Utillatge", grup: "ANC" },   
    { nom: "Mobiliari", grup: "ANC" },
    { nom: "Equips per al proc√©s de la informaci√≥", grup: "ANC" },
    { nom: "Elements de transport", grup: "ANC" },
    { nom: "Amortitzaci√≥ acumulada de l'immobilitzat material (AAIM)", grup: "ANC" },
    { nom: "Inversions en terrenys i b√©ns naturals", grup: "ANC" },
    { nom: "Inversions en construccions", grup: "ANC" },
    { nom: "Amortitzaci√≥ acumulada de les inversions immobili√†ries", grup: "ANC" },
    { nom: "Inversions financeres a llarg termini", grup: "ANC" },   
    { nom: "Mercaderies", grup: "AC" },
    { nom: "Mat√®ries primeres", grup: "AC" },
    { nom: "Productes acabats", grup: "AC" },
    { nom: "Altres aprovisionaments", grup: "AC" },   
    { nom: "Clients", grup: "AC" },
    { nom: "Clients, efectes comercials a cobrar", grup: "AC" },   
    { nom: "Deutors", grup: "AC" },
    { nom: "Deutors, efectes comercials a cobrar", grup: "AC" },   
    { nom: "Hisenda P√∫blica, deutora per diferents conceptes", grup: "AC" },
    { nom: "Inversions financeres a curt termini", grup: "AC" },
    { nom: "Bancs i institucions de cr√®dit", grup: "AC" },
    { nom: "Caixa", grup: "AC" },
    { nom: "Capital", grup: "PN" },
    { nom: "Reserva legal", grup: "PN" },
    { nom: "Reserves volunt√†ries", grup: "PN" },
    { nom: "Reserves estatut√†ries", grup: "PN" },
    { nom: "Resultat de l'exercici (guanys)", grup: "PN" },
    { nom: "Resultat de l'exercici (p√®rdues)", grup: "PN" },
    { nom: "Deutes a llarg termini amb entitats de cr√®dit", grup: "PNC" },
    { nom: "Prove√Ødors d'immobilitzat a llarg termini", grup: "PNC" },
    { nom: "Empr√®stits (obligacions i bons a llarg termini)", grup: "PNC" },
    { nom: "Prove√Ødors", grup: "PC" },
    { nom: "Prove√Ødors, efectes comercials a pagar", grup: "PC" },   
    { nom: "Creditors per prestaci√≥ de serveis", grup: "PC" },
    { nom: "Creditors, efectes comercials a pagar", grup: "PC" },     
    { nom: "Deutes a curt termini amb entitats de cr√®dit", grup: "PC" },
    { nom: "Hisenda P√∫blica, creditora per conceptes fiscals", grup: "PC" },
    { nom: "Organismes de la Seguretat Social, creditors", grup: "PC" },
    { nom: "Prove√Ødors d'immobilitzat a curt termini", grup: "PC" },   
];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let animationId;
    let score = 0;
    let lives = 3;
    let gameSpeed = CONFIG.velocitatInicial;
    let spawnRate = CONFIG.freqObstacles;
    let spawnTimer = 0; 
    let isGameOver = false;
    
    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    const player = {
        x: 50, y: 0, width: 40, height: 60,
        color: '#3498db', dy: 0, jumpPower: 17, gravity: 0.7, grounded: false,
        draw: function() {
            // EMOJI en lloc de dibuix
            ctx.font = '55px Arial'; 
            ctx.textAlign = 'left';
            ctx.fillText('ü§ì', this.x - 8, this.y + 55); 
        },
        update: function() {
            this.dy += this.gravity;
            this.y += this.dy;
            if (this.y + this.height > canvas.height - 20) {
                this.y = canvas.height - 20 - this.height;
                this.dy = 0;
                this.grounded = true;
            } else {
                this.grounded = false;
            }
            this.draw();
        },
        jump: function() {
            if (this.grounded) {
                this.dy = -this.jumpPower;
                this.grounded = false;
            }
        }
    };

    let obstacles = [];

    class Obstacle {
        constructor() {
            this.width = 50;
            this.height = 50;
            this.x = canvas.width;
            this.y = canvas.height - 20 - this.height;
            this.color = '#c0392b';
            this.account = comptesDB[Math.floor(Math.random() * comptesDB.length)];
            this.solved = false; 
        }
        draw() {
            // DIBUIX DE LA PILA DE PAPERS GROCS
            
            // Full 1 (fons)
            ctx.fillStyle = '#f9e79f'; // Groc p√†l¬∑lid fosc
            ctx.fillRect(this.x + 5, this.y + 10, 40, 40);
            ctx.strokeStyle = '#f1c40f'; // Contorn groc fort
            ctx.lineWidth = 1;
            ctx.strokeRect(this.x + 5, this.y + 10, 40, 40);
            
            // Full 2 (mig)
            ctx.fillStyle = '#f7dc6f'; // Groc mitj√†
            ctx.fillRect(this.x, this.y + 5, 40, 40);
            ctx.strokeRect(this.x, this.y + 5, 40, 40);
            
            // Full 3 (davant)
            ctx.fillStyle = '#f1c40f'; // Groc intens (Tipus Post-it/Folder)
            ctx.fillRect(this.x - 5, this.y, 40, 40);
            ctx.strokeRect(this.x - 5, this.y, 40, 40);
            
            // L√≠nies de text (gris fosc per contrastar amb el groc)
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(this.x, this.y + 10, 25, 3);
            ctx.fillRect(this.x, this.y + 18, 20, 3);
            ctx.fillRect(this.x, this.y + 26, 28, 3);
            
            // Indicador de resolt (Tick)
            if(this.solved) {
                ctx.fillStyle = '#27ae60'; // Verd m√©s fosc per contrastar amb el groc
                ctx.font = 'bold 30px Arial';
                ctx.fillText('‚úì', this.x + 5, this.y + 35);
            } else {
                ctx.fillStyle = '#c0392b'; // Interrogant vermell
                ctx.font = 'bold 24px Arial';
                ctx.fillText('?', this.x + 5, this.y + 30);
            }
        }
        update() {
            this.x -= gameSpeed;
            this.draw();
        }
    }

    function animate() {
        if (isGameOver) return;
        
        animationId = requestAnimationFrame(animate);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#7f8c8d';
        ctx.fillRect(0, canvas.height - 20, canvas.width, 20);

        spawnTimer++;
        if (spawnTimer >= spawnRate) {
            obstacles.push(new Obstacle());
            updateTextToNextObstacle();
            spawnTimer = 0; 
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            obs.update();

            if (player.x < obs.x + obs.width &&
                player.x + player.width > obs.x &&
                player.y < obs.y + obs.height &&
                player.y + player.height > obs.y) {
                
                handleCollision(i);
            }

            if (obs.x + obs.width < 0) {
                obstacles.splice(i, 1);
                updateTextToNextObstacle();
            }
        }

        player.update();
    }

    function startGame() {
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        document.getElementById('overlay').classList.add('hidden');
        resetGame();
        animate();
    }

    function resetGame() {
        isGameOver = false;
        score = 0;
        lives = 3;
        
        gameSpeed = CONFIG.velocitatInicial;
        spawnRate = CONFIG.freqObstacles;
        spawnTimer = 0;
        
        obstacles = [];
        player.y = canvas.height - 20 - player.height;
        player.dy = 0;
        
        obstacles.push(new Obstacle());
        updateTextToNextObstacle();
        
        // MOSTRAR HIGH SCORE
        const savedHighScore = localStorage.getItem('gestoriaRushHighScore') || 0;
        document.getElementById('scoreDisplay').innerHTML = `PUNTS: 0 <span style="font-size:0.7em; margin-left:10px; opacity:0.7;">R√àCORD: ${savedHighScore}</span>`;
        
        let heartsStr = "";
        for(let i=0; i<lives; i++) heartsStr += "‚ù§Ô∏è";
        document.getElementById('livesDisplay').innerText = heartsStr;
    }

    function handleCollision(index) {
        playSound('error'); 
        lives--;
        updateHUD();
        
        const gameView = document.getElementById('gameView');
        gameView.classList.remove('flash-red');
        void gameView.offsetWidth; 
        gameView.classList.add('flash-red');

        obstacles.splice(index, 1);
        updateTextToNextObstacle();

        if (lives <= 0) {
            endGame();
        }
    }

    function updateHUD() {
        const savedHighScore = localStorage.getItem('gestoriaRushHighScore') || 0;
        document.getElementById('scoreDisplay').innerHTML = `PUNTS: ${score} <span style="font-size:0.7em; margin-left:10px; opacity:0.7;">R√àCORD: ${savedHighScore}</span>`;
        let heartsStr = "";
        for(let i=0; i<lives; i++) heartsStr += "‚ù§Ô∏è";
        document.getElementById('livesDisplay').innerText = heartsStr;
    }

    function updateTextToNextObstacle() {
        const nextObs = obstacles.find(o => !o.solved);
        const textBox = document.getElementById('currentAccountText');
        
        if (nextObs) {
            textBox.innerText = nextObs.account.nom;
        } else {
            textBox.innerText = "...";
        }
    }

    function checkAnswer(selectedGroup) {
        if (isGameOver) return;
        const targetObs = obstacles.find(o => !o.solved);
        if (!targetObs) return;

        if (selectedGroup === targetObs.account.grup) {
            score++;
            targetObs.solved = true; 
            player.jump(); 
            playSound('jump'); 
            
            if (score % 5 === 0) {
                 gameSpeed = Math.min(gameSpeed + CONFIG.incrementVelocitat, CONFIG.velocitatMaxima);
                 spawnRate = Math.max(90, Math.floor(CONFIG.freqObstacles * (CONFIG.velocitatInicial / gameSpeed)));
            }

            updateHUD();
            updateTextToNextObstacle();
        } else {
            playSound('error'); 
            const qBox = document.getElementById('questionBox');
            qBox.classList.add('shake');
            setTimeout(() => qBox.classList.remove('shake'), 400);
        }
    }

    function endGame() {
        isGameOver = true;
        playSound('gameover'); 
        cancelAnimationFrame(animationId);
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('startContent').style.display = 'none';
        document.getElementById('gameOverContent').style.display = 'block';
        
        // GESTI√ì DEL HIGH SCORE I TEXT FINAL
        const currentHighScore = localStorage.getItem('gestoriaRushHighScore') || 0;
        let finalScoreHTML = `Has aconseguit <span id="finalScore">${score}</span> encerts`;
        
        if (score > currentHighScore) {
            localStorage.setItem('gestoriaRushHighScore', score);
            finalScoreHTML += `<br><span style="color:#2ecc71; font-size:1.1rem; font-weight:bold;">NOU R√àCORD PERSONAL!</span>`;
        }
        document.getElementById('finalScoreContainer').innerHTML = finalScoreHTML;
        
        // SISTEMA DE RANGS
        const reason = document.getElementById('deathReason');
        let rang = "";
        let colorRang = "";

        if (score < 5) { rang = "AUXILIAR EN PR√ÄCTIQUES"; colorRang = "#bdc3c7"; }
        else if (score < 15) { rang = "T√àCNIC COMPTABLE"; colorRang = "#3498db"; }
        else if (score < 30) { rang = "CAP DE COMPTABILITAT"; colorRang = "#9b59b6"; }
        else if (score < 50) { rang = "DIRECTOR FINANCER (CFO)"; colorRang = "#f1c40f"; }
        else { rang = "SOCI AUDITOR S√àNIOR"; colorRang = "#2ecc71"; }

        // MODIFICACI√ì: Mida m√©s petita (1.1rem) per evitar que es talli
        reason.innerHTML = `EL TEU RANG √âS<br><strong style="font-size:1.1rem; color:${colorRang};">${rang}</strong>`;
        
        document.getElementById('mainBtn').innerText = "TORNA A JUGAR";
    }
</script>
</body>
</html>
