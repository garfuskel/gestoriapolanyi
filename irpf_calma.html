<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Gestoria Polanyi - IRPF</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eeeeee;
      margin: 0;
      padding: 30px;
    }

    .contenidor {
      display: flex;
      gap: 25px;
      max-width: 1000px;
      margin: auto;
      align-items: flex-start;
    }

    /* â”€â”€â”€â”€â”€ COLUMNA ESQUERRA â”€â”€â”€â”€â”€ */
    .col-esquerra {
      width: 35%;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    /* â”€â”€â”€â”€â”€ CLIENT â”€â”€â”€â”€â”€ */
    .client {
      width: 100%;
      box-sizing: border-box;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .avatar-container {
      position: relative;
      display: inline-block;
      margin-bottom: 15px;
    }

    /* MODIFICAT: Sense marc, mÃ©s gran, amb ombra i inclinaciÃ³ */
    .client img {
      width: 220px;
      height: 220px;
      object-fit: cover;
      display: block; 
      border-radius: 4px; /* Un arrodoniment molt subtil perquÃ¨ no talli tant */
      box-shadow: 3px 5px 12px rgba(0,0,0,0.2);
      transform: rotate(-3deg); 
      
      /* NOU: Filtre matemÃ tic exacte per tenyir la imatge amb el color pur #fdfd96 */
      filter: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='tint'%3E%3CfeColorMatrix type='matrix' values='0.992 0 0 0 0 0 0.992 0 0 0 0 0 0.588 0 0 0 0 0 1 0'/%3E%3C/filter%3E%3C/svg%3E#tint");
    }

    .stamp {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg) scale(1.5);
      font-size: 2.5rem;
      font-weight: 900;
      text-transform: uppercase;
      border: 5px solid;
      border-radius: 10px;
      padding: 5px 15px;
      opacity: 0;
      pointer-events: none; 
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }

    .stamp.show {
      opacity: 0.9;
      transform: translate(-50%, -50%) rotate(-15deg) scale(1);
    }

    .stamp.correct {
      color: #27ae60;
      border-color: #27ae60;
      background-color: rgba(255, 255, 255, 0.7);
    }

    .stamp.fail {
      color: #c0392b;
      border-color: #c0392b;
      background-color: rgba(255, 255, 255, 0.7);
    }

    .client p {
      font-size: 1.05rem;
      font-style: italic; 
      color: #333;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      width: 90%;
    }

    /* â”€â”€â”€â”€â”€ POST-IT (CHULETA) â”€â”€â”€â”€â”€ */
    .post-it {
      background-color: #fff7d1;
      padding: 20px;
      box-shadow: 2px 4px 8px rgba(0,0,0,0.15);
      transform: rotate(-2deg);
      border-bottom-right-radius: 20px 5px;
      color: #333;
      /* Font mÃ©s informal per imitar apunts */
      font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', sans-serif; 
    }

    .post-it h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      text-align: center;
      border-bottom: 2px dashed #d4c890;
      padding-bottom: 5px;
      color: #555;
    }

    .taula-trams {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .taula-trams td {
      padding: 6px 2px;
      border-bottom: 1px dashed #e6dea6;
    }

    .taula-trams tr:last-child td {
      border-bottom: none;
    }

    .taula-trams td:first-child {
      text-align: left;
    }

    .taula-trams td:last-child {
      text-align: right;
      font-weight: bold;
      color: #d35400; /* SimulaciÃ³ de tinta de boli d'un altre color */
    }

    /* â”€â”€â”€â”€â”€ EXERCICI â”€â”€â”€â”€â”€ */
    .exercici {
      width: 65%;
      background-color: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .base {
      font-size: 1.3rem;
      font-weight: bold;
      margin: 10px 0 20px 0;
      color: #2c3e50;
    }

    /* â”€â”€â”€â”€â”€ INPUT I BOTONS â”€â”€â”€â”€â”€ */
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 1rem;
      box-sizing: border-box; 
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input:disabled {
      background-color: #e9ecef;
      cursor: not-allowed;
    }

    button {
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.2s;
    }

    button:hover:not(:disabled) {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    @keyframes wiggleSubtil {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-3px); }
      30% { transform: translateX(3px); }
      45% { transform: translateX(-1px); }
      60% { transform: translateX(1px); }
      75%, 100% { transform: translateX(0); }
    }

    .cridar-atencio {
      animation: wiggleSubtil 2.5s ease-in-out infinite;
      background-color: #2c3e50 !important; 
    }

    .feedback {
      margin-top: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
    }

    .correcte { color: #27ae60; }
    .incorrecte { color: #c0392b; }
    
    .desglossament {
      text-align: left;
      font-size: 0.95rem;
      color: #555;
      margin-top: 10px;
      padding-left: 20px;
    }
    
    .desglossament li {
      margin-bottom: 5px;
    }
  </style>
</head>

<body>

<div class="contenidor">

  <div class="col-esquerra">
    
    <div class="client">
      <div class="avatar-container">
        <img id="avatar" src="" alt="Client">
        <div id="stamp" class="stamp"></div>
      </div>
      
      <p id="missatge">
        Carregant clients...
      </p>
    </div>

    <div class="post-it">
      <h3>ðŸ“Œ Trams IRPF 2026</h3>
      <table class="taula-trams">
        <tr>
          <td>Fins a 12.450 â‚¬</td>
          <td>19%</td>
        </tr>
        <tr>
          <td>12.450 â‚¬ - 20.200 â‚¬</td>
          <td>24%</td>
        </tr>
        <tr>
          <td>20.200 â‚¬ - 35.200 â‚¬</td>
          <td>30%</td>
        </tr>
        <tr>
          <td>35.200 â‚¬ - 60.000 â‚¬</td>
          <td>37%</td>
        </tr>
        <tr>
          <td>60.000 â‚¬ - 300.000 â‚¬</td>
          <td>45%</td>
        </tr>
        <tr>
          <td>MÃ©s de 300.000 â‚¬</td>
          <td>47%</td>
        </tr>
      </table>
    </div>

  </div>

  <div class="exercici">
    <h2>Taula de trams (IRPF)</h2>

    <p>Base imposable del client:</p>
    <div class="base" id="base">-- â‚¬</div>

    <label>Quota dâ€™IRPF (â‚¬)</label>
    <input type="number" id="resposta" placeholder="Introdueix la quota" disabled>

    <button id="btn-comprovar" onclick="corregir()" disabled>Comprovar resposta</button>
    <button id="btn-nou-client" onclick="generarNouClient()" style="background-color: #95a5a6;" disabled>Nou client</button>

    <div class="feedback" id="feedback"></div>
  </div>

</div>

<script>
let baseImposable = 0;

let avatarsDisponibles = []; 
let poolAvatars = []; 

const frasesClients = [
  "Bon dia, em podries ajudar a calcular quÃ¨ he de pagar d'IRPF?",
  "Hola! Tenc la base imposable d'aquest any aquÃ­ mateix, quant em toca pagar?",
  "He estat fent nÃºmeros... Em confirmes la meva quota d'IRPF, per favor?",
  "Hisenda em fa una mica de por. Em pots fer el cÃ lcul de l'impost?",
  "Bones! Necessit saber la meva quota d'IRPF. Em donaries un cop de mÃ ?",
  "Hola! Tenc aquÃ­ les meves dades. Quant he de pagar?",
  "Sempre m'embull amb els trams... Em dius quina Ã©s la meva quota?",
  "Ei! Vull deixar-ho tot enllestit avui. Quant he de pagar d'IRPF?"
];

const frasesCorrecte = [
  "MoltÃ­ssimes grÃ cies! Aquesta gestoria Ã©s la millor.",
  "Perfecte! GrÃ cies per la teva ajuda.",
  "Genial, quadra perfectament amb el que havia calculat per sobre.",
  "Uf, quin pes em treus de sobre. GrÃ cies per l'ajuda!",
  "Molt amable. Que passis un bon dia!"
];

const frasesIncorrecte = [
  "Ostres... segur? Jo crec que no he de pagar aixÃ².",
  "Mmm... em sembla que t'has equivocat en algun tram. Ho pots revisar?",
  "AixÃ² no em quadra gens. Segur que has aplicat bÃ© els percentatges?",
  "No m'assustis! Crec que hi ha un error en els teus cÃ lculs.",
  "Vaja... crec que cercarÃ© una altra gestoria."
];

const formatDiners = (num) => new Intl.NumberFormat('ca-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
const formatSencer = (num) => new Intl.NumberFormat('ca-ES').format(num);

function descobrirAvatars(num) {
  const img = new Image();
  img.onload = function() {
    avatarsDisponibles.push(`avatars/client${num}.png`);
    descobrirAvatars(num + 1);
  };
  img.onerror = function() {
    if (avatarsDisponibles.length === 0) {
      avatarsDisponibles.push("avatars/client1.png"); 
    }
    
    document.getElementById("btn-nou-client").disabled = false;
    generarNouClient();
  };
  img.src = `avatars/client${num}.png`;
}

function obtenirAvatarAleatori() {
  if (poolAvatars.length === 0) {
    poolAvatars = [...avatarsDisponibles];
    
    for (let i = poolAvatars.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [poolAvatars[i], poolAvatars[j]] = [poolAvatars[j], poolAvatars[i]];
    }
  }
  return poolAvatars.pop();
}

function generarBase() {
  baseImposable = Math.floor(Math.random() * (80000 - 12000 + 1)) + 12000;
  document.getElementById("base").innerText = formatSencer(baseImposable) + " â‚¬";
}

function generarClient() {
  document.getElementById("avatar").src = obtenirAvatarAleatori();

  const indexFrase = Math.floor(Math.random() * frasesClients.length);
  document.getElementById("missatge").innerText = `"${frasesClients[indexFrase]}"`;
}

function generarNouClient() {
  generarBase();
  generarClient();
  
  document.getElementById("resposta").value = "";
  document.getElementById("resposta").disabled = false;
  document.getElementById("btn-comprovar").disabled = false;
  
  document.getElementById("btn-nou-client").classList.remove("cridar-atencio");
  
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("stamp").className = "stamp";
}

function calcularIRPFDetallat(base) {
  const trams = [
    { limit: 12450, tipus: 0.19 },
    { limit: 20200, tipus: 0.24 },
    { limit: 35200, tipus: 0.30 },
    { limit: 60000, tipus: 0.37 },
    { limit: 300000, tipus: 0.45 },
    { limit: Infinity, tipus: 0.47 }
  ];

  let quota = 0;
  let restant = base;
  let anterior = 0;
  let desglossament = [];

  for (let i = 0; i < trams.length; i++) {
    const t = trams[i];
    const baseTram = Math.min(t.limit - anterior, restant);
    
    if (baseTram > 0) {
      const quotaTram = baseTram * t.tipus;
      quota += quotaTram;
      
      const percentatge = (t.tipus * 100).toFixed(0);
      const limitText = t.limit === Infinity ? "la resta" : `fins a ${formatSencer(t.limit)} â‚¬`;
      
      desglossament.push(`<strong>Tram ${i + 1}</strong> (${limitText}): ${formatDiners(baseTram)} â‚¬ x ${percentatge}% = <strong>${formatDiners(quotaTram)} â‚¬</strong>`);
      
      restant -= baseTram;
      anterior = t.limit;
    }
  }
  
  return { total: quota, detalls: desglossament };
}

function corregir() {
  const respostaInput = document.getElementById("resposta");
  const resposta = parseFloat(respostaInput.value);
  const feedback = document.getElementById("feedback");
  const stamp = document.getElementById("stamp");
  const missatge = document.getElementById("missatge");
  const btnComprovar = document.getElementById("btn-comprovar");

  if (isNaN(resposta)) {
    feedback.innerHTML = "Introdueix una quota vÃ lida.";
    return;
  }

  respostaInput.disabled = true;
  btnComprovar.disabled = true;

  document.getElementById("btn-nou-client").classList.add("cridar-atencio");

  const resultatCÃ lcul = calcularIRPFDetallat(baseImposable);
  const correcta = resultatCÃ lcul.total;
  const diferencia = Math.abs(resposta - correcta);

  if (diferencia < 1) {
    stamp.innerText = "CORRECTE";
    stamp.className = "stamp correct show";
    
    const indexFrase = Math.floor(Math.random() * frasesCorrecte.length);
    missatge.innerText = `"${frasesCorrecte[indexFrase]}"`;
    
    feedback.innerHTML = `
      <p class="correcte"><strong>âœ” Correcte</strong></p>
      La quota dâ€™IRPF Ã©s <strong>${formatDiners(correcta)} â‚¬</strong>
    `;
  } else {
    stamp.innerText = "FAIL";
    stamp.className = "stamp fail show";
    
    const indexFrase = Math.floor(Math.random() * frasesIncorrecte.length);
    missatge.innerText = `"${frasesIncorrecte[indexFrase]}"`;
    
    let llistaHTML = "<ul class='desglossament'>";
    for (let detall of resultatCÃ lcul.detalls) {
      llistaHTML += `<li>${detall}</li>`;
    }
    llistaHTML += "</ul>";

    feedback.innerHTML = `
      <p class="incorrecte"><strong>âœ˜ Incorrecte</strong></p>
      La quota correcta Ã©s <strong>${formatDiners(correcta)} â‚¬</strong>.<br><br>
      <em>Mira el desglossament per veure on t'has equivocat:</em>
      ${llistaHTML}
    `;
  }
}

window.onload = function() {
  descobrirAvatars(1);
};
</script>

</body>
</html>