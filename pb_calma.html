<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Exercici Payback - Gestoria Polanyi</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fcfcfc;
        }
        
        .card {
            background: white;
            padding: 40px;
            width: 100%;
            max-width: 650px;
            height: 560px; /* Una mica més alt per encabir el botó extra */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .enunciat-container {
            flex-grow: 1;
            overflow-y: auto; 
            padding-right: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .enunciat {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            text-align: justify;
            width: 100%;
        }

        .controls {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        input {
            padding: 10px;
            width: 150px;
            text-align: center;
            border: 1px solid #ccc;
            font-size: 1rem;
            outline: none;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            font-size: 0.9rem;
            transition: opacity 0.2s;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.8;
        }

        /* Botó específic per quan no es recupera */
        .btn-norecover {
            background: white;
            color: #c0392b;
            border: 1px solid #c0392b;
            font-weight: 600;
        }
        .btn-norecover:hover {
            background: #fdf2f2;
            opacity: 1;
        }

        .btn-new {
            background: none;
            color: #888;
            text-decoration: underline;
            font-size: 0.8rem;
            margin-top: 0;
            border: none;
        }

        /* Àrea de missatges fixa */
        .message-area {
            text-align: center;
            height: 50px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }

        #feedback {
            font-size: 0.95rem;
            font-weight: 600;
        }

        #conclusion {
            font-size: 0.9rem;
            font-style: italic;
            color: #555;
            min-height: 1.2em; 
        }
    </style>
</head>
<body>

<div class="card">
    <div class="enunciat-container">
        <div id="enunciat" class="enunciat"></div>
    </div>
    
    <div class="controls">
        <div class="input-group">
            <input type="text" id="user-input" placeholder="Anys (ex: 2,45)">
            <button onclick="comprovarNumerico()">Verificar</button>
        </div>
        
        <button class="btn-norecover" onclick="comprovarNoRecupera()">La inversió NO es recupera</button>

        <button class="btn-new" onclick="generar()">Generar un altre exercici</button>
        
        <div class="message-area">
            <div id="feedback"></div>
            <div id="conclusion"></div>
        </div>
    </div>
</div>

<script>
    let resultatPayback = -1; // -1 indica que no es recupera. Si no, serà un float (anys).
    let inversioTotal = 0;
    let fluxosTotals = []; // Per guardar el flux net de cada any i fer el càlcul final

    function generar() {
        // Neteja interfície
        document.getElementById('feedback').innerText = '';
        document.getElementById('conclusion').innerText = '';
        document.getElementById('user-input').value = '';
        
        // Reiniciem variables
        fluxosTotals = [];
        
        // Paràmetres generals
        const tipus = Math.floor(Math.random() * 4) + 1;
        const anys = Math.floor(Math.random() * 3) + 2; // 2, 3 o 4 anys
        const inversio = (Math.floor(Math.random() * 10) + 5) * 100; // 500 a 1400
        inversioTotal = inversio;
        
        // Encara que el Payback no usa la 'k' per calcular, la posem per despistar/context
        const k_percent = Math.floor(Math.random() * 6) + 3; 
        
        // Valor Residual (50% probabilitat)
        let teResidual = Math.random() > 0.5;
        let residual = teResidual ? (Math.floor(Math.random() * 5) + 5) * 10 : 0; 

        let text = `Una empresa vol dur a terme un projecte que suposa una inversió inicial de ${inversio} euros. `;

        // --- LÒGICA DE GENERACIÓ I CÀLCUL DE FLUXOS NETS ---
        
        if (tipus === 1) {
            text += "Se sap que els fluxos de caixa previstos per als propers anys són els següents: ";
            let partsFluxos = [];
            for (let i = 1; i <= anys; i++) {
                let esNegatiu = Math.random() < 0.15;
                let q = esNegatiu ? -1 * (Math.floor(Math.random() * 2) + 1) * 100 : (Math.floor(Math.random() * 4) + 3) * 100;
                
                fluxosTotals.push(q); // Guardem el flux base
                partsFluxos.push(`l'any ${i} és de ${q} euros`);
            }
            text += partsFluxos.slice(0, -1).join(", ") + " i " + partsFluxos.slice(-1) + ". ";
        } 
        else if (tipus === 2 || tipus === 3) {
            let partsFluxos = [];
            for (let i = 1; i <= anys; i++) {
                let cobraments = (Math.floor(Math.random() * 5) + 6) * 100; 
                let esNegatiu = Math.random() < 0.15;
                let pagaments;
                if (esNegatiu) {
                    pagaments = cobraments + ((Math.floor(Math.random() * 3) + 1) * 100); 
                } else {
                    pagaments = (Math.floor(Math.random() * 4) + 2) * 100; 
                    if(pagaments >= cobraments) pagaments = cobraments - 100;
                }

                let q = cobraments - pagaments;
                fluxosTotals.push(q);

                partsFluxos.push(`l'any ${i} té uns cobraments de ${cobraments} euros i uns pagaments de ${pagaments} euros`);
            }
            text += "La informació de tresoreria indica que " + partsFluxos.join("; ") + ". ";
        }
        else {
            // Tipus 4: Explotació
            let preu = Math.floor(Math.random() * 5) + 8;
            let cvu = preu - 4; 
            let unitats = 1000; 
            
            text += `L'explotació del negoci durant els ${anys} anys de durada presenta aquestes dades: el preu de venda és de ${preu} euros, el cost variable unitari és de ${cvu} euros. `;
            
            let detallsAnys = [];
            for (let i = 1; i <= anys; i++) {
                let cf = 3000; 
                let esNegatiu = Math.random() < 0.15;
                if(esNegatiu) cf = (unitats * (preu - cvu)) + 500; 

                let q = (unitats * (preu - cvu)) - cf;
                fluxosTotals.push(q);
                
                detallsAnys.push(`any ${i} (CF: ${cf}€)`);
            }
            text += `Les unitats venudes són constants (${unitats} u.) però els costos fixos varien: ${detallsAnys.join(", ")}. `;
        }

        // Sumar el valor residual a l'últim any
        if (teResidual) {
            text += `A més, se sap que la inversió té un valor residual de ${residual} euros al final de l'últim any. `;
            fluxosTotals[fluxosTotals.length - 1] += residual;
        }

        text += `Calcula el termini de recuperació (Payback) d'aquest projecte.`;
        
        // --- CÀLCUL DEL PAYBACK ---
        calcularPayback();

        document.getElementById('enunciat').innerText = text;
    }

    function calcularPayback() {
        let acumulat = 0;
        resultatPayback = -1; // Per defecte: no recupera

        for (let i = 0; i < fluxosTotals.length; i++) {
            let fluxAny = fluxosTotals[i];
            
            // Comprovem si amb aquest any ja recuperem (o superem) la inversió
            if (acumulat + fluxAny >= inversioTotal) {
                let pendent = inversioTotal - acumulat;
                // Payback = Anys complets transcorreguts (i) + fracció de l'any actual
                // Si estem a l'índex 0 (Any 1), han passat 0 anys complets.
                let fraccio = pendent / fluxAny;
                resultatPayback = i + fraccio;
                return; // Ja l'hem trobat
            }
            
            acumulat += fluxAny;
        }
        // Si acaba el bucle i no ha entrat al if, resultatPayback es queda en -1
    }

    function comprovarNumerico() {
        let valInput = document.getElementById('user-input').value.trim();
        const feedback = document.getElementById('feedback');
        const conclusion = document.getElementById('conclusion');

        if (valInput === "") {
            feedback.style.color = "#e67e22"; 
            feedback.innerText = "Introdueix una resposta numèrica";
            return;
        }

        // Si l'alumne introdueix un número però la resposta correcta era "No recupera"
        if (resultatPayback === -1) {
            feedback.style.color = "#e74c3c"; 
            feedback.innerText = "Incorrecte. Aquesta inversió no es recupera mai.";
            conclusion.innerText = "Hauries d'haver premut el botó 'La inversió NO es recupera'.";
            return;
        }

        let rawInput = valInput.replace(',', '.');
        const userVal = parseFloat(rawInput);
        
        if (isNaN(userVal)) {
            feedback.style.color = "#e67e22";
            feedback.innerText = "El format no és vàlid";
            return;
        }

        if (Math.abs(userVal - resultatPayback) < 0.05) { // Marge petit (decimals)
            feedback.style.color = "#27ae60"; 
            feedback.innerText = "Correcte! El payback és " + resultatPayback.toFixed(2).replace('.', ',') + " anys.";
            conclusion.innerText = "La inversió es recupera durant l'any " + Math.ceil(resultatPayback) + ".";
        } else {
            feedback.style.color = "#e74c3c"; 
            feedback.innerText = "Incorrecte. El resultat exacte era " + resultatPayback.toFixed(2).replace('.', ',') + " anys.";
            conclusion.innerText = "";
        }
    }

    function comprovarNoRecupera() {
        const feedback = document.getElementById('feedback');
        const conclusion = document.getElementById('conclusion');

        if (resultatPayback === -1) {
            feedback.style.color = "#27ae60"; 
            feedback.innerText = "Correcte! La suma dels fluxos no arriba a cobrir la inversió.";
            conclusion.innerText = "El projecte no recupera els diners en el temps previst.";
        } else {
            feedback.style.color = "#e74c3c"; 
            feedback.innerText = "Incorrecte. La inversió SÍ que es recupera.";
            conclusion.innerText = "Es recuperava en " + resultatPayback.toFixed(2).replace('.', ',') + " anys.";
        }
    }

    window.onload = generar;
</script>
</body>
</html>