<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Exercici TIR - Gestoria Polanyi</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fcfcfc;
        }
        
        .card {
            background: white;
            padding: 40px;
            width: 100%;
            max-width: 650px;
            height: 530px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .enunciat-container {
            flex-grow: 1;
            overflow-y: auto; 
            padding-right: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .enunciat {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            text-align: justify;
            width: 100%;
        }

        .controls {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        input {
            padding: 10px;
            width: 200px;
            text-align: center;
            border: 1px solid #ccc;
            font-size: 1rem;
            outline: none;
        }

        button {
            padding: 10px 25px;
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        .btn-new {
            background: none;
            color: #888;
            text-decoration: underline;
            font-size: 0.8rem;
            margin-top: 0;
        }

        /* Àrea de missatges fixa */
        .message-area {
            text-align: center;
            height: 50px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }

        #feedback {
            font-size: 0.95rem;
            font-weight: 600;
        }

        #conclusion {
            font-size: 0.9rem;
            font-style: italic;
            color: #555;
            min-height: 1.2em; 
        }
    </style>
</head>
<body>

<div class="card">
    <div class="enunciat-container">
        <div id="enunciat" class="enunciat"></div>
    </div>
    
    <div class="controls">
        <input type="text" id="user-input" placeholder="Resultat (ex: 12,50)">
        <button onclick="comprovar()">Verificar</button>
        <button class="btn-new" onclick="generar()">Generar un altre exercici</button>
        
        <div class="message-area">
            <div id="feedback"></div>
            <div id="conclusion"></div>
        </div>
    </div>
</div>

<script>
    let respostaCorrecta = 0; // Serà la TIR en %
    let kBenchmark = 0;       // Cost del capital per comparar

    function generar() {
        // Neteja interfície visual (només si és la primera crida, no en recursió interna)
        // Però com que modifiquem el DOM al final, està bé.
        document.getElementById('feedback').innerText = '';
        document.getElementById('conclusion').innerText = '';
        document.getElementById('user-input').value = '';
        
        // Paràmetres generals
        const tipus = Math.floor(Math.random() * 4) + 1;
        const anys = 2; // SEMPRE 2 ANYS
        const inversio = (Math.floor(Math.random() * 10) + 5) * 100; // 500 a 1400
        const k_percent = Math.floor(Math.random() * 6) + 3; // 3% a 8%
        
        kBenchmark = k_percent;
        
        // Valor Residual (50% probabilitat)
        let teResidual = Math.random() > 0.5;
        let residual = teResidual ? (Math.floor(Math.random() * 5) + 5) * 10 : 0; 

        let text = `Una empresa vol dur a terme un projecte que suposa una inversió inicial de ${inversio} euros. `;
        
        let q1 = 0;
        let q2 = 0;

        // --- LÒGICA DE GENERACIÓ D'ENUNCIAT ---
        
        if (tipus === 1) {
            text += "Se sap que els fluxos de caixa previstos són: ";
            
            // Q1
            let esNegatiu1 = Math.random() < 0.15;
            q1 = esNegatiu1 ? -1 * (Math.floor(Math.random() * 2) + 1) * 100 : (Math.floor(Math.random() * 4) + 3) * 100;
            
            // Q2 (base)
            let esNegatiu2 = Math.random() < 0.15;
            let q2Base = esNegatiu2 ? -1 * (Math.floor(Math.random() * 2) + 1) * 100 : (Math.floor(Math.random() * 4) + 3) * 100;
            
            text += `l'any 1 és de ${q1} euros i l'any 2 és de ${q2Base} euros. `;
            q2 = q2Base; 
        } 
        else if (tipus === 2 || tipus === 3) {
            let c1 = (Math.floor(Math.random() * 5) + 6) * 100;
            let p1 = (Math.floor(Math.random() * 4) + 2) * 100;
            if(Math.random() < 0.15) p1 = c1 + 200;
            
            let c2 = (Math.floor(Math.random() * 5) + 6) * 100;
            let p2 = (Math.floor(Math.random() * 4) + 2) * 100;
            if(Math.random() < 0.15) p2 = c2 + 200;

            q1 = c1 - p1;
            q2 = c2 - p2;
            
            text += `La informació de tresoreria indica que l'any 1 té uns cobraments de ${c1} euros i uns pagaments de ${p1} euros; i l'any 2 té uns cobraments de ${c2} euros i uns pagaments de ${p2} euros. `;
        }
        else {
            let preu = Math.floor(Math.random() * 5) + 8;
            let cvu = preu - 4; 
            let unitats = 1000; 
            
            text += `L'explotació del negoci durant els 2 anys de durada presenta aquestes dades: el preu de venda és de ${preu} euros, el cost variable unitari és de ${cvu} euros. `;
            
            let cf1 = 3000;
            if(Math.random() < 0.15) cf1 = (unitats * (preu - cvu)) + 500;
            q1 = (unitats * (preu - cvu)) - cf1;

            let cf2 = 3000;
            if(Math.random() < 0.15) cf2 = (unitats * (preu - cvu)) + 500;
            q2 = (unitats * (preu - cvu)) - cf2;
            
            text += `Les unitats venudes són constants (${unitats} u.) però els costos fixos varien: any 1 (CF: ${cf1}€) i any 2 (CF: ${cf2}€). `;
        }

        if (teResidual) {
            text += `A més, se sap que la inversió té un valor residual de ${residual} euros al final del segon any. `;
            q2 += residual; 
        }

        text += `Si el cost del capital és del ${k_percent}%, calcula la TIR d'aquest projecte.`;
        
        // --- CÀLCUL I FILTRATGE (POSSITIU) ---
        
        let a = inversio;
        let b = -q1;
        let c = -q2;
        
        let discriminant = (b * b) - (4 * a * c);
        
        // Si no té solució real o si el discriminant és negatiu -> regenerem
        if (discriminant < 0) {
            generar(); 
            return;
        }

        let x = (-b + Math.sqrt(discriminant)) / (2 * a);
        let tir = (x - 1) * 100; 

        // --- FILTRE CRÍTIC: TIR POSITIVA ---
        // Si la TIR és negativa o zero (o molt propera a zero, < 0.01), regenerem
        if (tir <= 0.01 || isNaN(tir)) {
            generar(); // Recursivitat: torna a provar fins que surti positiva
            return;    // Atura l'execució actual per no pintar l'enunciat "dolent"
        }

        // Si arribem aquí, tenim una TIR positiva vàlida
        respostaCorrecta = tir;
        document.getElementById('enunciat').innerText = text;
    }

    function comprovar() {
        let valInput = document.getElementById('user-input').value.trim();
        const feedback = document.getElementById('feedback');
        const conclusion = document.getElementById('conclusion');

        if (valInput === "") {
            feedback.style.color = "#e67e22"; 
            feedback.innerText = "Introdueix una resposta";
            conclusion.innerText = "";
            return;
        }

        let rawInput = valInput.replace(',', '.').replace('%', '');
        const userVal = parseFloat(rawInput);
        
        if (isNaN(userVal)) {
            feedback.style.color = "#e67e22";
            feedback.innerText = "El format no és vàlid";
            conclusion.innerText = "";
            return;
        }

        // Feedback del número (Marge de 0.1)
        if (Math.abs(userVal - respostaCorrecta) < 0.1) {
            feedback.style.color = "#27ae60"; 
            feedback.innerText = "Correcte. El resultat és " + respostaCorrecta.toFixed(2).replace('.', ',') + "%";
        } else {
            feedback.style.color = "#e74c3c"; 
            feedback.innerText = "Incorrecte. El resultat era " + respostaCorrecta.toFixed(2).replace('.', ',') + "%";
        }

        // Feedback de la rendibilitat
        if (respostaCorrecta > kBenchmark) {
            conclusion.innerText = `Com que la TIR (${respostaCorrecta.toFixed(2)}%) > k (${kBenchmark}%), el projecte ÉS rendible.`;
            conclusion.style.color = "#27ae60"; 
        } else {
            conclusion.innerText = `Com que la TIR (${respostaCorrecta.toFixed(2)}%) < k (${kBenchmark}%), el projecte NO és rendible.`;
            conclusion.style.color = "#c0392b"; 
        }
    }

    window.onload = generar;
</script>
</body>
</html>