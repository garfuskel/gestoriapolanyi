<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Exercici VAN - Gestoria Polanyi</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fcfcfc;
        }
        
        .card {
            background: white;
            padding: 40px;
            width: 100%;
            max-width: 650px;
            height: 530px; /* He augmentat 30px per encabir la frase final còmodament */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .enunciat-container {
            flex-grow: 1;
            overflow-y: auto; 
            padding-right: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .enunciat {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            text-align: justify;
            width: 100%;
        }

        .controls {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        input {
            padding: 10px;
            width: 200px;
            text-align: center;
            border: 1px solid #ccc;
            font-size: 1rem;
            outline: none;
        }

        button {
            padding: 10px 25px;
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        .btn-new {
            background: none;
            color: #888;
            text-decoration: underline;
            font-size: 0.8rem;
            margin-top: 0;
        }

        /* Àrea de missatges fixa */
        .message-area {
            text-align: center;
            height: 50px; /* Espai fix per a les dues línies de text */
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }

        #feedback {
            font-size: 0.95rem;
            font-weight: 600;
        }

        #conclusion {
            font-size: 0.9rem;
            font-style: italic;
            color: #555;
            min-height: 1.2em; /* Reserva l'espai */
        }
    </style>
</head>
<body>

<div class="card">
    <div class="enunciat-container">
        <div id="enunciat" class="enunciat"></div>
    </div>
    
    <div class="controls">
        <input type="text" id="user-input" placeholder="Resultat (ex: 125,40)">
        <button onclick="comprovar()">Verificar</button>
        <button class="btn-new" onclick="generar()">Generar un altre exercici</button>
        
        <div class="message-area">
            <div id="feedback"></div>
            <div id="conclusion"></div>
        </div>
    </div>
</div>

<script>
    let respostaCorrecta = 0;

    function generar() {
        // Neteja interfície
        document.getElementById('feedback').innerText = '';
        document.getElementById('conclusion').innerText = '';
        document.getElementById('user-input').value = '';
        
        // Paràmetres generals
        const tipus = Math.floor(Math.random() * 4) + 1;
        const anys = Math.floor(Math.random() * 3) + 2; // 2, 3 o 4 anys
        const inversio = (Math.floor(Math.random() * 10) + 5) * 100; // 500 a 1400
        const k_percent = Math.floor(Math.random() * 6) + 3; // 3% a 8%
        const k = k_percent / 100;
        
        // Valor Residual (50% probabilitat)
        let teResidual = Math.random() > 0.5;
        let residual = teResidual ? (Math.floor(Math.random() * 5) + 5) * 10 : 0; 

        let text = `Una empresa vol dur a terme un projecte que suposa una inversió inicial de ${inversio} euros. `;
        let sumaActualitzada = 0;

        // --- LÒGICA DE GENERACIÓ (Igual que abans) ---
        
        if (tipus === 1) {
            text += "Se sap que els fluxos de caixa previstos per als propers anys són els següents: ";
            let partsFluxos = [];
            for (let i = 1; i <= anys; i++) {
                let esNegatiu = Math.random() < 0.15;
                let q;
                if (esNegatiu) {
                     q = -1 * (Math.floor(Math.random() * 2) + 1) * 100; 
                } else {
                     q = (Math.floor(Math.random() * 4) + 3) * 100; 
                }

                let fluxTotal = q;
                if (i === anys && teResidual) fluxTotal += residual; 
                
                partsFluxos.push(`l'any ${i} és de ${q} euros`);
                sumaActualitzada += fluxTotal / Math.pow(1 + k, i);
            }
            text += partsFluxos.slice(0, -1).join(", ") + " i " + partsFluxos.slice(-1) + ". ";
        } 
        else if (tipus === 2 || tipus === 3) {
            let partsFluxos = [];
            for (let i = 1; i <= anys; i++) {
                let cobraments = (Math.floor(Math.random() * 5) + 6) * 100; 
                let esNegatiu = Math.random() < 0.15;
                let pagaments;
                if (esNegatiu) {
                    pagaments = cobraments + ((Math.floor(Math.random() * 3) + 1) * 100); 
                } else {
                    pagaments = (Math.floor(Math.random() * 4) + 2) * 100; 
                    if(pagaments >= cobraments) pagaments = cobraments - 100;
                }

                let q = cobraments - pagaments;
                if (i === anys && teResidual) q += residual;
                
                partsFluxos.push(`l'any ${i} té uns cobraments de ${cobraments} euros i uns pagaments de ${pagaments} euros`);
                sumaActualitzada += q / Math.pow(1 + k, i);
            }
            text += "La informació de tresoreria indica que " + partsFluxos.join("; ") + ". ";
        }
        else {
            let preu = Math.floor(Math.random() * 5) + 8;
            let cvu = preu - 4; 
            let unitats = 1000; 
            
            text += `L'explotació del negoci durant els ${anys} anys de durada presenta aquestes dades: el preu de venda és de ${preu} euros, el cost variable unitari és de ${cvu} euros. `;
            
            let detallsAnys = [];
            for (let i = 1; i <= anys; i++) {
                let cf = 3000; 
                let esNegatiu = Math.random() < 0.15;
                if(esNegatiu) {
                    cf = (unitats * (preu - cvu)) + 500; 
                }

                let q = (unitats * (preu - cvu)) - cf;
                if (i === anys && teResidual) q += residual;
                
                detallsAnys.push(`any ${i} (CF: ${cf}€)`);
                sumaActualitzada += q / Math.pow(1 + k, i);
            }
            
            text += `Les unitats venudes són constants (${unitats} u.) però els costos fixos varien: ${detallsAnys.join(", ")}. `;
        }

        if (teResidual) {
            text += `A més, se sap que la inversió té un valor residual de ${residual} euros al final de l'últim any. `;
        }

        text += `Si el cost del capital és del ${k_percent}%, calcula el VAN d'aquest projecte.`;
        
        respostaCorrecta = -inversio + sumaActualitzada;
        document.getElementById('enunciat').innerText = text;
    }

    function comprovar() {
        let valInput = document.getElementById('user-input').value.trim();
        const feedback = document.getElementById('feedback');
        const conclusion = document.getElementById('conclusion');

        if (valInput === "") {
            feedback.style.color = "#e67e22"; 
            feedback.innerText = "Introdueix una resposta";
            conclusion.innerText = "";
            return;
        }

        let rawInput = valInput.replace(',', '.');
        const userVal = parseFloat(rawInput);
        
        if (isNaN(userVal)) {
            feedback.style.color = "#e67e22";
            feedback.innerText = "El format no és vàlid";
            conclusion.innerText = "";
            return;
        }

        // Feedback del número
        if (Math.abs(userVal - respostaCorrecta) < 0.5) {
            feedback.style.color = "#27ae60"; 
            feedback.innerText = "Correcte. El resultat és " + respostaCorrecta.toFixed(2).replace('.', ',') + "€";
        } else {
            feedback.style.color = "#e74c3c"; 
            feedback.innerText = "Incorrecte. El resultat era " + respostaCorrecta.toFixed(2).replace('.', ',') + "€";
        }

        // Feedback de la rendibilitat (sempre es mostra)
        if (respostaCorrecta > 0) {
            conclusion.innerText = "Segons el criteri del VAN, el projecte és rendible.";
            conclusion.style.color = "#27ae60"; // Verd fosc
        } else {
            conclusion.innerText = "Segons el criteri del VAN, el projecte NO és rendible.";
            conclusion.style.color = "#c0392b"; // Vermell fosc
        }
    }

    window.onload = generar;
</script>
</body>
</html>