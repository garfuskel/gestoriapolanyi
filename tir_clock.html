<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIR - Contra-rellotge</title>
    <style>
        /* --- ESTILS GENERALS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* --- CRONÒMETRE SUPERIOR --- */
        #timer-container { 
            width: 100%; 
            background-color: #e2e8f0; 
            height: 35px; 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 1000; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        #timer-bar { 
            width: 100%; 
            height: 100%; 
            background-color: #48bb78; 
            transition: width 0.1s linear, background-color 0.5s; 
        }
        
        #ui-overlay { 
            position: absolute; 
            width: 100%; 
            height: 100%;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 0 20px; 
            box-sizing: border-box; 
            font-weight: bold; 
            font-size: 1.1rem; 
            color: #2d3748; 
            text-transform: uppercase;
        }

        /* --- TARGETA CENTRAL (FIXA) --- */
        .card {
            background: white;
            padding: 40px;
            width: 90%;
            max-width: 650px;
            height: 530px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            margin-top: 40px; 
            position: relative;
        }

        .enunciat-container {
            flex-grow: 1;
            overflow-y: auto; 
            padding-right: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .enunciat {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            text-align: justify;
            width: 100%;
        }

        .controls {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        input {
            padding: 12px;
            width: 220px;
            text-align: center;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1.2rem;
            outline: none;
            transition: border 0.3s;
        }
        input:focus { border-color: #3182ce; }

        button {
            padding: 12px 30px;
            cursor: pointer;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s, background 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.98); }
        button:hover { background: #34495e; }

        #input-warning {
            height: 20px;
            color: #e67e22;
            font-weight: bold;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* --- OVERLAYS --- */
        .overlay-feedback {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); 
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        .msg-box {
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            max-width: 800px;
            width: 90%;
            background: white;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .feedback-layout {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            text-align: left;
            gap: 30px;
        }
        
        .feedback-info { flex: 1; }
        .feedback-img-container { flex: 1; display: flex; justify-content: center; }
        
        /* ANIMACIÓ DE LA IMATGE */
        @keyframes rotateIn {
            0% { transform: rotate(-10deg) scale(0.8); opacity: 0; }
            100% { transform: rotate(0deg) scale(1); opacity: 1; }
        }

        .rank-img {
            max-width: 100%;
            height: auto;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 4px solid #fff;
            animation: rotateIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .msg-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .msg-subtitle { font-size: 1.3rem; margin-bottom: 10px; color: #4a5568; }
        
        .type-success .msg-box { border-left: 10px solid #48bb78; }
        .type-warning .msg-box { border-left: 10px solid #ecc94b; }
        .type-error .msg-box { border-left: 10px solid #f56565; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 700px) {
            .feedback-layout { flex-direction: column; text-align: center; }
            .card { height: auto; min-height: 500px; }
        }

    </style>
</head>
<body>

<div id="timer-container">
    <div id="ui-overlay">
        <div>NIVELL <span id="level-display">0</span></div>
        <div>ENCERTS: <span id="score-display">0</span></div>
    </div>
    <div id="timer-bar"></div>
</div>

<div class="card">
    <div class="enunciat-container">
        <div id="enunciat" class="enunciat">Carregant exercici...</div>
    </div>
    
    <div class="controls">
        <div id="input-warning">Introdueix una resposta</div>
        <input type="text" id="user-input" placeholder="Resultat (ex: 12,50)" autocomplete="off">
        <button id="btn-action" onclick="checkAnswer()">VERIFICAR</button>
    </div>
</div>

<script>
    // --- CONFIGURACIÓ DE DIFICULTAT ---
    
    const RANKS = [
        "Aspirant", "Becari", "Auxiliar", "Júnior", 
        "Sènior", "Cap d'Equip", "Analista", "Gerent", 
        "Director", "Soci", "Llegenda de les finances"
    ];

    // Velocitat del cronòmetre (Més baix = Més fàcil)
    const BASE_DECREMENT = 0.15; 
    // Acceleració per nivell (Més baix = Corba més suau)
    const LEVEL_MULTIPLIER = 0.05; 
    // Recompensa màxima en segons
    const MAX_BONUS = 50; 

    // Variables d'Estat
    let timerWidth = 100;
    let score = 0;
    let level = 0;
    let attemptsLeft = 3; 
    let gameLoopInterval = null;
    let isGameRunning = false;
    
    // Variables Matemàtiques TIR
    let respostaCorrecta = 0;
    let kBenchmark = 0; // Per comparar rendibilitat

    // --- MOTOR DEL JOC ---

    function startGame() {
        score = 0;
        level = 0;
        timerWidth = 100;
        isGameRunning = true;
        
        updateTopBar();
        generarProblema();
        
        if (gameLoopInterval) clearInterval(gameLoopInterval);
        gameLoopInterval = setInterval(gameLoop, 100); 
    }

    function gameLoop() {
        if (!isGameRunning) return;

        let currentDecrement = BASE_DECREMENT + (level * LEVEL_MULTIPLIER);
        timerWidth -= currentDecrement;

        const bar = document.getElementById("timer-bar");
        bar.style.width = Math.max(0, timerWidth) + "%";
        
        if (timerWidth < 30) bar.style.backgroundColor = "#e53e3e";
        else if (timerWidth < 60) bar.style.backgroundColor = "#ecc94b";
        else bar.style.backgroundColor = "#48bb78";

        if (timerWidth <= 0) {
            triggerGameOver("TEMPS ESGOTAT");
        }
    }

    function updateTopBar() {
        document.getElementById("score-display").innerText = score;
        document.getElementById("level-display").innerText = level;
    }

    // --- GENERADOR DE PROBLEMES (Lògica TIR 2 Anys) ---
    function generarProblema() {
        document.getElementById('user-input').value = '';
        document.getElementById('input-warning').style.opacity = '0';
        document.getElementById('user-input').focus();
        attemptsLeft = 3; 
        
        const tipus = Math.floor(Math.random() * 4) + 1;
        const anys = 2; // SEMPRE 2 ANYS
        const inversio = (Math.floor(Math.random() * 10) + 5) * 100; // 500 a 1400
        const k_percent = Math.floor(Math.random() * 6) + 3; // 3% a 8%
        
        kBenchmark = k_percent;
        
        let teResidual = Math.random() > 0.5;
        let residual = teResidual ? (Math.floor(Math.random() * 5) + 5) * 10 : 0; 

        let text = `Una empresa vol dur a terme un projecte que suposa una inversió inicial de ${inversio} euros. `;
        let q1 = 0, q2 = 0;

        if (tipus === 1) {
            text += "Se sap que els fluxos de caixa previstos són: ";
            
            let esNegatiu1 = Math.random() < 0.15;
            q1 = esNegatiu1 ? -1 * (Math.floor(Math.random() * 2) + 1) * 100 : (Math.floor(Math.random() * 4) + 3) * 100;
            
            let esNegatiu2 = Math.random() < 0.15;
            let q2Base = esNegatiu2 ? -1 * (Math.floor(Math.random() * 2) + 1) * 100 : (Math.floor(Math.random() * 4) + 3) * 100;
            
            text += `l'any 1 és de ${q1} euros i l'any 2 és de ${q2Base} euros. `;
            q2 = q2Base; 
        } 
        else if (tipus === 2 || tipus === 3) {
            let c1 = (Math.floor(Math.random() * 5) + 6) * 100;
            let p1 = (Math.floor(Math.random() * 4) + 2) * 100;
            if(Math.random() < 0.15) p1 = c1 + 200;
            
            let c2 = (Math.floor(Math.random() * 5) + 6) * 100;
            let p2 = (Math.floor(Math.random() * 4) + 2) * 100;
            if(Math.random() < 0.15) p2 = c2 + 200;

            q1 = c1 - p1;
            q2 = c2 - p2;
            
            text += `La informació de tresoreria indica que l'any 1 té uns cobraments de ${c1} euros i uns pagaments de ${p1} euros; i l'any 2 té uns cobraments de ${c2} euros i uns pagaments de ${p2} euros. `;
        }
        else {
            let preu = Math.floor(Math.random() * 5) + 8;
            let cvu = preu - 4; 
            let unitats = 1000; 
            
            text += `L'explotació del negoci durant els 2 anys de durada presenta aquestes dades: el preu de venda és de ${preu} euros, el cost variable unitari és de ${cvu} euros. `;
            
            let cf1 = 3000;
            if(Math.random() < 0.15) cf1 = (unitats * (preu - cvu)) + 500;
            q1 = (unitats * (preu - cvu)) - cf1;

            let cf2 = 3000;
            if(Math.random() < 0.15) cf2 = (unitats * (preu - cvu)) + 500;
            q2 = (unitats * (preu - cvu)) - cf2;
            
            text += `Les unitats venudes són constants (${unitats} u.) però els costos fixos varien: any 1 (CF: ${cf1}€) i any 2 (CF: ${cf2}€). `;
        }

        if (teResidual) {
            text += `A més, se sap que la inversió té un valor residual de ${residual} euros al final del segon any. `;
            q2 += residual; 
        }

        text += `Si el cost del capital és del ${k_percent}%, calcula la TIR d'aquest projecte.`;
        
        // --- CÀLCUL TIR (Equació 2n Grau) ---
        let a = inversio;
        let b = -q1;
        let c = -q2;
        let discriminant = (b * b) - (4 * a * c);
        
        // Filtre 1: Discriminant negatiu (no solució real)
        if (discriminant < 0) {
            generarProblema(); return;
        }

        let x = (-b + Math.sqrt(discriminant)) / (2 * a);
        let tir = (x - 1) * 100; 

        // Filtre 2: TIR Positiva (la teva petició)
        if (tir <= 0.01 || isNaN(tir)) {
            generarProblema(); return;
        }

        respostaCorrecta = tir;
        document.getElementById('enunciat').innerText = text;
    }

    // --- VERIFICACIÓ ---
    function checkAnswer() {
        if (!isGameRunning) return;

        let valInput = document.getElementById('user-input').value.trim();
        const warning = document.getElementById('input-warning');

        if (valInput === "") {
            warning.innerText = "Introdueix una resposta";
            warning.style.opacity = '1';
            return;
        }

        // Permetre comes, punts i símbol %
        let rawInput = valInput.replace(',', '.').replace('%', '');
        let userVal = parseFloat(rawInput);
        
        if (isNaN(userVal)) {
            warning.innerText = "El format no és vàlid";
            warning.style.opacity = '1';
            return;
        }

        warning.style.opacity = '0'; 

        // Marge 0.1 per a la TIR
        if (Math.abs(userVal - respostaCorrecta) < 0.1) {
            handleSuccess();
        } else {
            handleFailure();
        }
    }

    function handleSuccess() {
        score++;
        
        // Recompensa variable
        let baseReward = MAX_BONUS - (level * 1.5); 
        let earnedBonus = 0;
        let messageBonus = "";

        if (attemptsLeft === 3) {
            earnedBonus = baseReward;
            messageBonus = `+${earnedBonus.toFixed(0)}s (Perfecte!)`;
        } else if (attemptsLeft === 2) {
            earnedBonus = baseReward * 0.5;
            messageBonus = `+${earnedBonus.toFixed(0)}s (Segon intent)`;
        } else {
            earnedBonus = baseReward * 0.25;
            messageBonus = `+${earnedBonus.toFixed(0)}s (Pèls pèls...)`;
        }

        timerWidth = Math.min(100, timerWidth + earnedBonus);
        
        if (score % 2 === 0 && level < 10) level++;
        
        updateTopBar();

        // Frase Rentabilitat (TIR vs k)
        let fraseRentabilitat = "";
        if (respostaCorrecta > kBenchmark) {
            fraseRentabilitat = `Com que TIR (${respostaCorrecta.toFixed(2)}%) > k (${kBenchmark}%), és RENDIBLE ✅`;
        } else {
            fraseRentabilitat = `Com que TIR (${respostaCorrecta.toFixed(2)}%) < k (${kBenchmark}%), NO és rendible ❌`;
        }

        showOverlay("CORRECTE!", `${fraseRentabilitat}<br><span style="color:#276749; font-size:0.9em">${messageBonus}</span>`, "success", 2000);
        
        setTimeout(() => {
            generarProblema();
        }, 2000);
    }

    function handleFailure() {
        attemptsLeft--;
        
        if (attemptsLeft === 2) {
            showOverlay("INCORRECTE", "Et queden 2 intents. Revisa l'equació de 2n grau!", "warning", 2000);
            document.getElementById('user-input').select(); 
        } else if (attemptsLeft === 1) {
            showOverlay("ATENCIÓ!", "Darrera oportunitat!", "warning", 2000);
            document.getElementById('user-input').select();
        } else {
            let solucio = respostaCorrecta.toFixed(2).replace('.', ',') + "%";
            showOverlay("EXPEDIENT PERDUT", `La solució era: ${solucio}.<br>Passem al següent.`, "error", 3000);
            timerWidth -= 5; 
            setTimeout(() => {
                generarProblema(); 
            }, 3000);
        }
    }

    // --- OVERLAYS I GAME OVER ---
    function showOverlay(titol, subtitol, tipus, durada) {
        let old = document.querySelector('.overlay-feedback');
        if (old) old.remove();

        const overlay = document.createElement("div");
        overlay.className = `overlay-feedback type-${tipus}`;
        overlay.innerHTML = `
            <div class="msg-box">
                <div class="msg-title">${titol}</div>
                <div class="msg-subtitle">${subtitol}</div>
            </div>
        `;
        document.body.appendChild(overlay);

        if (durada) {
            setTimeout(() => {
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
            }, durada);
        }
    }

    function triggerGameOver(motiuTitle) {
        isGameRunning = false;
        clearInterval(gameLoopInterval);
        
        let rangFinal = level >= RANKS.length ? RANKS[RANKS.length - 1] : RANKS[level];
        let numImatge = Math.min(10, level);
        let imatgePath = `nivells/nivell${numImatge}.jpg`;

        const overlay = document.createElement("div");
        overlay.className = "overlay-feedback type-error";
        overlay.style.zIndex = "6000";
        
        overlay.innerHTML = `
            <div class="msg-box" style="max-width:900px;">
                <div class="feedback-layout">
                    <div class="feedback-info">
                        <div class="msg-title" style="color:#e53e3e; font-size:2.5rem;">GAME OVER</div>
                        <div class="msg-subtitle" style="font-weight:bold; color:#333;">${motiuTitle}</div>
                        
                        <div style="background:#f7fafc; padding:20px; border-radius:10px; margin-top:15px; border-left:5px solid #2b6cb0;">
                            <div style="font-size:0.9rem; color:#718096; text-transform:uppercase; letter-spacing:1px;">Rang Assolit</div>
                            <div style="font-size:1.8rem; font-weight:bold; color:#2c5282;">${rangFinal}</div>
                            <div style="margin-top:10px; font-size:1.2rem;">
                                Nivell: <b>${level}</b> | Encerts: <b>${score}</b>
                            </div>
                        </div>

                        <button onclick="startGame(); document.querySelector('.overlay-feedback').remove();" 
                                style="background:#3182ce; color:white; padding:15px 40px; border-radius:8px; border:none; cursor:pointer; font-size:1.2rem; font-weight:bold; margin-top:30px; width:100%; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                            TORNA A JUGAR
                        </button>
                    </div>
                    
                    <div class="feedback-img-container">
                        <img src="${imatgePath}" class="rank-img" alt="Rang ${rangFinal}" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") checkAnswer();
    });

    window.onload = startGame;

</script>
</body>
</html>